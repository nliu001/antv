markdown
# AntV X6 图形化布局设计规范：自由画布与动态系统容器

## 1. 核心设计原则
*   **意图导向**：画布默认处于“手动自由布局”模式，尊重用户的视觉直觉与业务排布经验。
*   **逻辑内敛**：系统容器（Parent）不仅是视觉框，更是逻辑作用域，负责管理子元素（Children）的空间边界。
*   **数据驱动 (Data-Driven)**：所有业务信息挂载于 `cell.data`，布局信息通过 X6 事件系统与 Vue 响应式状态实时同步。

## 2. 手动布局规范 (Manual Layout)

### 2.1 基础物理规则
*   **坐标吸附 (Snapping)**：开启全局网格（Grid），步长建议设为 10px。
*   **辅助对齐 (Snapline)**：启用对齐线插件。当设备边缘或中心点靠近其他元素时，触发视觉引导并产生磁吸感。
*   **层级管理 (Z-Index)**：
    *   子节点（设备）的 `zIndex` 必须始终高于父节点（容器）。
    *   拖拽元素时，动态提升该元素及其子树的 `zIndex` 至顶层，松手后复位。

### 2.2 容器自动扩容规范 (Auto-Expansion) —— [方案一核心]
*   **触发机制**：监听子节点的 `change:position`（位移）和 `change:size`（缩放）事件。
*   **动态包裹逻辑**：
    *   **计算包围盒 (BBox)**：实时获取容器内所有子元素的并集区域（Union）。
    *   **动态填充 (Padding)**：在并集区域四周预留固定间距（建议 30px - 50px）作为容器的新边界。
    *   **双向联动**：子节点移动带动容器扩容；容器移动带动子节点整体平移（利用 X6 `embedded` 属性）。
*   **尺寸约束**：容器需设定 `minWidth` 和 `minHeight`，防止在空状态下塌陷。

### 2.3 边界交互逻辑
*   **入组规则**：设备中心点进入容器范围并停留 >200ms 时，容器触发高亮反馈。松手后执行 `parent.addChild(child)`。
*   **出组规则**：设备被拖离容器边界且超过 50% 面积外溢时，执行 `parent.removeChild(child)`，设备恢复为画布一级节点。

## 3. 自动化布局规范 (Automated Layout)

### 3.1 动作定位
*   自动化布局被定义为“瞬时整理工具”。用户通过工具栏主动触发算法（如 Dagre 或 Grid），完成后系统立即归还手动控制权。

### 3.2 局部整理规则
*   **作用域限定**：支持仅对选中的单个容器执行“内部整理”，不干扰画布上其他已手动排好的区域。
*   **非重叠保证**：算法必须配置最小间距 $Gap \ge 20px$，确保每个图例都有足够的双击交互空间。

### 3.3 意图保护 (Locking)
*   **标记位**：在 `data` 中维护 `isManual: boolean`。
*   **增量策略**：标记为 `true` 的节点在自动化布局中作为“固定锚点”，算法仅计算其他未锁定节点的空间分布。

## 4. 业务与交互关联

### 4.1 事件钩子
*   **双击设备 (Device)**：触发自定义 `node:dblclick` 事件，唤起 Vue 侧的业务维护弹窗/抽屉。
*   **双击容器 (System)**：触发系统属性编辑（如修改系统名称、配置整体参数）。

### 4.2 视觉语义化
*   **状态反馈**：当设备业务数据异常时，通过 X6 节点样式（如边框红闪、警告图标）实时呈现。
*   **语义缩放 (LOD)**：在大比例缩小画布时，自动隐藏设备详细文字，仅保留图标。

## 5. 技术实现参考 (AntV X6 + Vue 3)
*   **节点渲染**：推荐使用 `@antv/x6-vue-shape`，利用 Vue 组件构建设备图例。
*   **性能优化**：使用 `markRaw` 包装 X6 Graph 实例，避免 Vue 对其深度监听导致的性能损耗。
*   **坐标同步**：入组/出组时调用坐标转换函数，确保在绝对坐标与相对坐标切换时位置无跳变。

---
**审查状态：** 待评审  
**版本：** 1.0.0