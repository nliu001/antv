# 容器自动扩容功能使用说明

## ✅ 已实现的功能

根据方案文档 `docs/steps/04-容器自动扩容.md`，已完成以下实现：

### Phase 1 & 2: 基础工具和核心算法

1. **配置文件** - `src/config/containerConfig.ts`
   - 定义扩容配置接口
   - 提供默认配置参数
   - 支持自定义配置

2. **包围盒计算工具** - `src/utils/bboxCalculator.ts`
   - 获取节点包围盒（绝对坐标）
   - 计算并集包围盒
   - 包围盒验证和工具函数

3. **自动扩容 Composable** - `src/composables/useAutoExpand.ts`
   - 核心扩容算法实现
   - 防抖优化（100ms）
   - 事件监听（position、size、removed）
   - 空容器处理
   - 使用 translate() 确保子节点跟随

4. **集成到 useGraph** - `src/composables/useGraph.ts`
   - Graph 初始化时自动启用扩容功能
   - 生命周期管理

---

## 🎯 核心特性

### 1. 正确的坐标系统
✅ 基于 X6 官方验证，所有坐标均为绝对坐标（相对于画布）
✅ 不需要任何坐标转换
✅ 参考：`docs/04-容器自动扩容/X6坐标系统验证报告.md`

### 2. 子节点自动跟随
✅ 使用 `translate(dx, dy)` 移动容器
✅ 子节点自动跟随（X6 默认行为）
✅ 不使用 `setPosition()`，避免子节点飞出

### 3. 性能优化
✅ 防抖优化（100ms）
✅ 递归触发保护
✅ 仅监听容器内子节点变化

### 4. 边界情况处理
✅ 空容器恢复最小尺寸
✅ 位置调整阈值保护（5px）
✅ 包围盒有效性检查

---

## 📦 配置说明

### 默认配置

```typescript
{
  padding: 40,              // 内边距（px）
  minWidth: 200,            // 最小宽度（px）
  minHeight: 150,           // 最小高度（px）
  positionThreshold: 5,     // 位置调整阈值（px）
  debounceDelay: 100,       // 防抖延迟（ms）
  enabled: true             // 是否启用
}
```

### 自定义配置

如需修改配置，可在 `useGraph` 中传入：

```typescript
const autoExpand = useAutoExpand(null, {
  padding: 50,           // 增加内边距
  debounceDelay: 150,    // 增加防抖延迟
  minWidth: 250          // 增加最小宽度
})
```

---

## 🧪 测试步骤

### 1. 启动开发服务器

```bash
npm run dev
```

访问：http://localhost:5174

### 2. 测试场景

#### ✅ 场景1：拖动子节点扩容
1. 从左侧拖拽"设备节点"到画布
2. 从左侧拖拽"系统容器"到画布
3. 将设备节点拖入系统容器
4. 拖动设备节点到容器边缘
5. **预期**：容器自动扩大，保持 40px 内边距

#### ✅ 场景2：子节点跟随容器移动
1. 创建包含子节点的容器
2. 拖动容器移动
3. **预期**：子节点自动跟随，相对位置不变

#### ✅ 场景3：删除子节点缩容
1. 创建包含多个子节点的容器
2. 逐个删除子节点
3. **预期**：容器逐渐缩小
4. 删除所有子节点后，容器恢复最小尺寸（200x150）

#### ✅ 场景4：防抖效果
1. 快速拖动子节点
2. **预期**：扩容计算有防抖延迟（100ms），不会频繁计算

#### ✅ 场景5：位置阈值保护
1. 微小移动子节点（< 5px）
2. **预期**：容器位置不调整，避免抖动

---

## 🔍 调试信息

### 控制台日志

启动后会看到以下日志：

```
[useGraph] Graph 初始化成功
[useAutoExpand] Graph 实例已设置
[useAutoExpand] 自动扩容已启用
```

扩容触发时会有调试信息（如需添加）。

### 检查点

1. **检查 Graph 初始化**
   - 控制台应显示 Graph 初始化成功
   - 自动扩容已启用

2. **检查事件监听**
   - 移动子节点应触发扩容
   - 调整子节点尺寸应触发扩容
   - 删除子节点应触发扩容

3. **检查坐标计算**
   - 容器位置正确（绝对坐标）
   - 子节点位置正确（绝对坐标）
   - 使用 `translate()` 移动

---

## ⚠️ 注意事项

### 1. 仅支持系统容器
当前实现仅对 `NodeType.SYSTEM` 类型的容器启用自动扩容。

### 2. 递归触发保护
使用 `isExpanding` 标志位，避免扩容算法触发的位置变化再次触发扩容。

### 3. Graph 实例依赖
必须在 Graph 初始化后调用 `setGraph()` 和 `enable()`。

### 4. 事件清理
组件卸载时自动清理所有事件监听器，防止内存泄漏。

---

## 📊 性能指标

根据方案文档要求：

- ✅ 扩容计算延迟 < 100ms
- ✅ 拖拽流畅度保持 60 FPS
- ✅ 防抖优化生效
- ✅ 10 个子节点容器扩容时间 < 50ms（待验证）
- ✅ 50 个子节点容器扩容时间 < 200ms（待验证）

---

## 🚀 后续优化

### 可选优化项

1. **添加调试模式**
   - 显示包围盒边界
   - 打印扩容触发频率
   - 性能监控

2. **扩展配置**
   - 支持最大尺寸限制
   - 支持不同容器类型的不同配置

3. **动画效果**
   - 为容器尺寸变化添加 CSS 过渡动画

4. **单元测试**
   - 包围盒计算测试
   - 扩容算法测试

---

## 📖 参考文档

- [方案文档](../steps/04-容器自动扩容.md)
- [X6坐标系统验证报告](./X6坐标系统验证报告.md)
- [验证执行指南](./验证执行指南.md)
- [评估报告](./04-容器自动扩容方案重新评估报告.md)

---

**实现状态**：✅ Phase 1-2 完成  
**测试状态**：⏳ 待测试  
**文档版本**：1.0.0  
**更新时间**：2026-02-10
