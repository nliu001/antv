# X6 坐标系统验证结果报告

**验证日期**：2026-02-10  
**X6 版本**：基于项目当前依赖版本  
**验证方式**：官方文档查阅 + 实际 Demo 测试

---

## 一、官方文档查阅结果

### 1.1 关于 `node.getBBox()` 的官方说明

**文档来源**：https://x6.antv.vision/zh/docs/api/model/node

#### 官方 API 定义
```typescript
getBBox(options: { deep?: boolean }): Rectangle
```

#### 官方描述（原文）
> **获取节点的包围盒。**
> 
> 需要注意的是，该方法通过节点的大小和位置计算包围盒，并不是渲染到画布后的包围盒，涉及的计算只是一些算数运算。

#### 参数说明
| 名称 | 类型 | 必选 | 默认值 | 描述 |
| --- | --- | --- | --- | --- |
| options.deep | boolean |  | false | 为 true 时表示包含所有子节点和边的包围盒，默认为 false。 |

#### 关键信息提取
1. ✅ `getBBox()` **通过节点的大小和位置计算**
2. ✅ 涉及的是**算数运算**，不依赖 DOM 渲染
3. ⚠️ 文档**未明确说明**返回的坐标系是绝对还是相对

#### 推断
- 由于 `getBBox()` 基于 `position` 和 `size` 计算
- 而 `position()` 默认返回绝对坐标（除非传入 `{ relative: true }`）
- **推断**：`getBBox()` 返回的坐标应该也是**绝对坐标**

---

### 1.2 关于 `node.position()` 的官方说明

**文档来源**：https://x6.antv.vision/zh/docs/api/model/node

#### 官方 API 定义
```typescript
/**
 * 获取节点位置。
 */
position(options?: Node.GetPositionOptions): Point.PointLike
```

#### 参数说明
| 名称 | 类型 | 必选 | 默认值 | 描述 |
| --- | --- | --- | --- | --- |
| options.relative | boolean |  | false | 是否返回相对于父节点的相对位置，**默认为 false 表示返回节点相对于画布的绝对位置**。 |

#### 官方示例代码
```typescript
const pos = rect.position()
console.log(pos.x, pos.y)

const relativePos = child.position({ relative: true })
console.log(relativePos.x, relativePos.y)
```

#### 关键结论
✅ **官方明确**：`position()` 默认返回**绝对坐标**（相对于画布）  
✅ **官方明确**：需要传入 `{ relative: true }` 才返回相对坐标

---

### 1.3 关于 `container.resize()` 的官方说明

**文档来源**：https://x6.antv.vision/zh/docs/api/model/node

#### 官方 API 定义
```typescript
resize(
  width: number,
  height: number,
  options?: Node.ResizeOptions
): this
```

#### 参数说明（direction）
| 名称 | 类型 | 必选 | 默认值 | 描述 |
| --- | --- | --- | --- | --- |
| options.direction | Direction |  | **'bottom-right'** | 向哪个方向改变大小，**默认左上角固定**，往右下角改变节点大小。 |

#### 支持的 direction 值
- `top`
- `right`
- `bottom`
- `left`
- `top-left`
- `top-right`
- `bottom-left`
- **`bottom-right`**（默认值）

#### 官方示例
```typescript
node.resize(100, 40)

// 右下角固定，向左上角改变大小
node.resize(100, 40, { direction: 'top-left' })
```

#### 关键结论
✅ **官方明确**：`resize()` 默认 `direction: 'bottom-right'`  
✅ **官方明确**：默认行为是**左上角固定**，往右下角改变节点大小  
✅ **推论**：默认情况下，`resize()` 不会改变节点的 `position`（左上角坐标）

---

### 1.4 关于 `graph.getCellsBBox()` 的查找结果

**查找范围**：
- X6 官方文档 API 参考
- X6 GitHub 仓库
- 第三方教程和博客

#### 查找结果
✅ **已确认**：`getCellsBBox()` 是 **graph 实例方法**，不是静态方法

#### 官方 API 定义（推断）
```typescript
graph.getCellsBBox(cells: Cell[]): Rectangle | null
```

#### 使用示例
```typescript
// ❌ 错误用法（静态方法）
const bbox = Graph.getCellsBBox([child1, child2])

// ✅ 正确用法（实例方法）
const bbox = graph.getCellsBBox([child1, child2])
```

#### 关键信息
- ✅ 方法签名：接受 Cell 数组作为参数
- ✅ 返回值：Rectangle 对象（包含 x, y, width, height）
- ⚠️ 坐标系定义：文档未明确说明，需要通过实测验证

#### 参考来源
- OpenDeep Wiki: https://opendeep.wiki/antvis/x6/graph
- 使用示例：`graph.getCellsBBox(cells)` 用于获取多个 cells 的并集包围盒

---

## 二、实际测试验证（BBoxVerifyDemo.vue）

### 2.1 验证方法
创建了 `BBoxVerifyDemo.vue` 组件，包含 4 个独立测试：
1. Q1：验证 `node.getBBox()` 的坐标系
2. Q2：验证 `Graph.getCellsBBox()` 的坐标系
3. Q3：验证容器移动时子节点是否跟随
4. Q4：验证 `resize()` 的锚点位置

### 2.2 测试步骤
1. 在 `App.vue` 中临时引入 `<BBoxVerifyDemo />`
2. 点击"运行验证"按钮
3. 查看右侧面板的输出结果
4. 记录关键数据

### 2.3 预期结果

#### Q1 预期
基于官方文档推断：
- ✅ `getBBox()` 应该返回**绝对坐标**
- 即：`getBBox().x === getPosition().x`

#### Q2 预期
需要实测验证：
- 可能情况 A：返回绝对坐标（与 `getBBox()` 一致）
- 可能情况 B：返回相对于父容器的坐标

#### Q3 预期
用户已确认：
- ✅ 子节点会**自动跟随**容器移动
- 即：移动容器后，子节点的绝对坐标也会相应变化

#### Q4 预期
基于官方文档：
- ✅ 默认情况下，`resize()` **不改变** `position`
- 即：调整前后 `position` 应该相同

---

## 三、验证执行指南

### 3.1 运行 Demo 的步骤

#### 步骤 1：修改 App.vue
```vue
<!-- src/App.vue -->
<script setup lang="ts">
import BBoxVerifyDemo from '@/components/canvas/BBoxVerifyDemo.vue'
</script>

<template>
  <BBoxVerifyDemo />
</template>
```

#### 步骤 2：启动开发服务器
```bash
npm run dev
```

#### 步骤 3：打开浏览器
访问 `http://localhost:5173`

#### 步骤 4：执行验证
1. 点击右侧面板的"运行验证"按钮
2. 观察左侧画布的节点创建情况
3. 查看右侧面板的验证结果输出

#### 步骤 5：记录结果
将控制台输出和右侧面板的文本复制到本文档的"四、实测结果记录"部分

---

## 四、实测结果记录

### 4.1 Q1: node.getBBox() 坐标系

**测试场景**：
- 容器位置：(100, 100)
- 子节点位置：(150, 150)
- 子节点尺寸：50 x 50

**实测输出**：
```
// 待填写：运行 Demo 后的实际输出
容器 position: { x: 100, y: 100 }
子节点 position: { x: 150, y: 150 }
子节点 getBBox: { x: ?, y: ?, width: 50, height: 50 }
```

**结论判断**：
- [ ] `getBBox().x = 150` → **绝对坐标** ✅
- [ ] `getBBox().x = 50` → **相对坐标**

---

### 4.2 Q2: Graph.getCellsBBox() 坐标系

**测试场景**：
- 容器位置：(100, 100)
- 子节点1：(150, 150, 50x50)
- 子节点2：(250, 250, 50x50)

**实测输出**：
```
// 待填写：运行 Demo 后的实际输出
并集包围盒: { x: ?, y: ?, width: 150, height: 150 }
```

**结论判断**：
- [ ] `getCellsBBox().x = 150` → **绝对坐标** ✅
- [ ] `getCellsBBox().x = 50` → **相对坐标**

---

### 4.3 Q3: 容器移动子节点跟随

**测试场景**：
- 容器从 (100, 100) 使用 `translate(-20, -20)` 移动到 (80, 80)
- 子节点初始位置 (150, 150)

**实测输出**：
```
移动前：
- 容器 position: { x: 100, y: 100 }
- 子节点 position: { x: 150, y: 150 }

执行：container.translate(-20, -20)  // 向左上移动 20px

移动后：
- 容器 position: { x: 80, y: 80 }
- 子节点 position: { x: 130, y: 130 }

【结论】：
- 容器偏移量：{ dx: -20, dy: -20 }
- 子节点自动跟随移动 ✅
- 子节点偏移量：{ dx: -20, dy: -20 }
```

**✅ 关键验证结果**：
子节点**会自动跟随**父节点移动（从 150,150 移动到 130,130）

**官方文档说明**：
> "需要注意的是，子节点的位置是相对画布左上角的位置，我们并没有提供相对父节点的相对定位方法。在上面例子中，我们通过绝对定位和 zIndex 使子节点看起来像位于父节点内部一样，**当移动父节点时子节点也会跟着移动**。实际上，即便子节点位于父节点外部，移动父节点时子节点也将跟着移动。"

来源：https://x6.antv.vision/zh/docs/tutorial/basic/group

**重要发现**：
1. ✅ 使用 `translate()` 方法移动节点时，子节点**会自动跟随**
2. ⚠️ 使用 `setPosition()` 方法**不会**触发子节点跟随（这是测试初期的错误用法）
3. ✅ 这是 X6 的**默认行为**，**不需要**启用 `embedding` 配置

**扩容算法设计影响**：
```typescript
function autoExpandContainer(container: Node, graph: Graph) {
  const children = container.getChildren()
  const unionBBox = graph.getCellsBBox(children)
  
  const oldPos = container.getPosition()
  const newX = unionBBox.x - PADDING
  const newY = unionBBox.y - PADDING
  
  // 计算偏移量
  const dx = newX - oldPos.x
  const dy = newY - oldPos.y
  
  // ✅ 关键：使用 translate() 会自动让子节点跟随
  container.translate(dx, dy)
  container.resize(
    Math.max(unionBBox.width + PADDING * 2, MIN_WIDTH),
    Math.max(unionBBox.height + PADDING * 2, MIN_HEIGHT)
  )
  
  // ✅ 不需要手动调整子节点坐标！
}
```

---

### 4.4 Q4: resize() 锚点位置

**测试场景**：
- 容器初始：(100, 100, 200x200)
- 执行 `resize(300, 300)`

**实测输出**：
```
// 待填写：运行 Demo 后的实际输出
调整前 position: { x: 100, y: 100 }
调整后 position: { x: ?, y: ? }
```

**官方文档结论**：
✅ 默认 `direction: 'bottom-right'`，左上角固定  
✅ 预期 `position` 不变

---

## 五、基于验证结果的方案调整

### 5.1 如果 Q1 结果为"绝对坐标"

**需要删除的内容**（在 04-容器自动扩容.md）：
1. ❌ 第 5.3.1 节"相对坐标影响"
2. ❌ 第 5.3.2 节 `getAbsoluteBBox()` 函数

**需要添加的说明**：
```markdown
### 5.3 坐标系统说明

#### 5.3.1 X6 子节点的坐标系（官方验证）
根据 X6 官方文档和实测验证：
- ✅ `node.getPosition()` 默认返回**绝对坐标**（相对于画布）
- ✅ `node.getBBox()` 返回的坐标也是**绝对坐标**
- ✅ 仅当调用 `position({ relative: true })` 时才返回相对坐标

**重要**：X6 的 `addChild()` 不改变子节点的坐标值，子节点始终使用绝对坐标。

参考：https://x6.antv.vision/zh/docs/api/model/node#position
```

---

### 5.2 如果 Q2 结果为"绝对坐标"

**扩容算法设计调整**：

原错误设计（假设返回相对坐标）：
```typescript
const offsetX = unionBBox.x - PADDING
const offsetY = unionBBox.y - PADDING
```

正确设计（绝对坐标）：
```typescript
// 1. 获取子节点并集包围盒（绝对坐标）
const unionBBox = Graph.getCellsBBox(children)

// 2. 计算容器新位置（包围盒左上角 - PADDING）
const newX = unionBBox.x - PADDING
const newY = unionBBox.y - PADDING

// 3. 计算容器新尺寸
const newWidth = Math.max(unionBBox.width + PADDING * 2, MIN_WIDTH)
const newHeight = Math.max(unionBBox.height + PADDING * 2, MIN_HEIGHT)

// 4. 应用新位置和尺寸
container.setPosition(newX, newY)  // 直接设置新位置
container.setSize(newWidth, newHeight)
```

---

### 5.3 Q3 已确认（子节点自动跟随）

**✅ 验证结论**：
子节点**会自动跟随**父节点移动（使用 `translate()` 方法）

**影响**：
✅ 扩容算法调整容器位置后，**无需手动更新子节点坐标**  
✅ X6 的 embedded 机制会自动处理子节点的位置

**关键技术点**：
1. ✅ **必须使用** `translate(dx, dy)` 而非 `setPosition(x, y)`
2. ✅ `translate()` 会触发 X6 内部的子节点跟随机制
3. ✅ 这是 X6 的**默认行为**，不需要额外配置

**错误用法对比**：
```typescript
// ❌ 错误：使用 setPosition()，子节点不会跟随
container.setPosition(newX, newY)

// ✅ 正确：使用 translate()，子节点自动跟随
const dx = newX - container.getPosition().x
const dy = newY - container.getPosition().y
container.translate(dx, dy)
```

**官方文档依据**：
https://x6.antv.vision/zh/docs/tutorial/basic/group

---

### 5.4 Q4 已明确（左上角固定）

**影响**：
✅ 默认 `resize()` 不会改变 `position`  
✅ 扩容时可以先 `setPosition()`，再 `resize()`  
✅ 或者使用 `setSize()` 代替 `resize()`

**推荐实现**：
```typescript
// 方案 A：分步设置
container.setPosition(newX, newY)
container.setSize(newWidth, newHeight)

// 方案 B：使用 prop 批量更新
container.prop({
  position: { x: newX, y: newY },
  size: { width: newWidth, height: newHeight }
})
```

---

## 六、最终结论与行动计划

### 6.1 确定性知识（官方文档明确）
1. ✅ `node.position()` 默认返回**绝对坐标**
2. ✅ `resize()` 默认 `direction: 'bottom-right'`，左上角固定
3. ✅ 子节点会自动跟随父节点移动（embedded 机制）

### 6.2 需要实测验证的内容
1. ⏳ `node.getBBox()` 的坐标系（高概率是绝对坐标）
2. ⏳ `Graph.getCellsBBox()` 的坐标系（需要验证）

### 6.3 下一步行动
1. **立即执行**：运行 `BBoxVerifyDemo.vue`，记录 Q1、Q2 实测结果
2. **验证完成后**：更新本文档第四部分"实测结果记录"
3. **方案调整**：根据验证结果修改 `04-容器自动扩容.md`
4. **开始实现**：基于确定的 API 行为编写扩容算法

---

## 七、官方文档引用清单

| API | 文档链接 | 关键信息 |
|-----|---------|---------|
| `node.getBBox()` | [链接](https://x6.antv.vision/zh/docs/api/model/node#getbbox) | 基于 position 和 size 计算 |
| `node.position()` | [链接](https://x6.antv.vision/zh/docs/api/model/node#position) | 默认返回绝对坐标 |
| `node.resize()` | [链接](https://x6.antv.vision/zh/docs/api/model/node#resize) | 默认左上角固定 |
| 父子节点 | [链接](https://x6.antv.vision/zh/docs/tutorial/basic/group) | embedded 机制说明 |

---

**文档版本**：1.0.0  
**状态**：⏳ 等待实测验证 Q1、Q2  
**下次更新**：填写实测结果后
