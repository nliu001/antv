# AntV X6 图形化布局系统 - 总体实施目标

## 目录
- [1. 项目背景](#1-项目背景)
- [2. 总体目标](#2-总体目标)
- [3. 核心功能清单](#3-核心功能清单)
- [4. 实施步骤概览](#4-实施步骤概览)
- [5. 技术架构设计](#5-技术架构设计)
- [6. 质量保证策略](#6-质量保证策略)
- [7. 验收标准](#7-验收标准)
- [8. 里程碑与交付物](#8-里程碑与交付物)

---

## 1. 项目背景

### 1.1 业务场景
基于 AntV X6 图形引擎，构建一套支持**手动自由布局**和**智能自动布局**相结合的图形化系统，用于数字孪生平台中的设备拓扑管理。

### 1.2 核心诉求
- **意图导向**：优先保障用户手动排布的视觉直觉
- **逻辑内敛**：容器作为逻辑作用域，自动管理子元素边界
- **数据驱动**：业务信息与布局信息实时同步
- **灵活切换**：支持手动布局与自动布局无缝切换

### 1.3 技术基础
- **前端框架**：Vue 3.5.24 + TypeScript 5.9.3
- **构建工具**：Vite 7.2.4
- **图形引擎**：@antv/x6 3.1.6
- **UI 组件**：Element Plus 2.13.2
- **状态管理**：Pinia 3.0.4

---

## 2. 总体目标

### 2.1 功能目标
实现一套**生产级别**的图形化布局系统，支持：

1. **基础画布能力**
   - 无限画布拖拽与缩放
   - 网格吸附与对齐线辅助
   - 多节点框选与批量操作

2. **自定义节点系统**
   - 设备节点（Device）：可视化设备图例
   - 系统容器（System）：逻辑分组容器
   - 支持 Vue 组件化渲染

3. **智能交互体验**
   - 节点拖拽至画布
   - 设备入组/出组容器
   - 容器自动扩容
   - 双击触发业务编辑

4. **布局算法集成**
   - Dagre 层级布局
   - Grid 网格布局
   - 局部整理功能
   - 锁定机制保护手动布局

5. **业务数据扩展**
   - 节点自定义数据模型
   - 数据持久化与恢复
   - 状态视觉反馈

### 2.2 性能目标
- 支持 **500+ 节点**流畅交互（60 FPS）
- 容器扩容计算延迟 < 100ms
- 画布初始化加载时间 < 2s

### 2.3 体验目标
- 拖拽操作响应时间 < 16ms
- 容器入组反馈延迟 < 200ms
- 自动布局执行时间 < 1s

---

## 3. 核心功能清单

### 3.1 Phase 1 - 基础画布（P0）
| 功能项 | 优先级 | 说明 |
|--------|--------|------|
| Graph 实例初始化 | P0 | 创建画布实例并配置基础参数 |
| 网格吸附 | P0 | 10px 步长的网格系统 |
| 对齐线 | P0 | 动态显示对齐辅助线 |
| 缩放与平移 | P0 | 鼠标滚轮缩放、空白区域拖拽 |
| 工具栏 | P0 | 放大/缩小/适应画布/全屏 |

### 3.2 Phase 2 - 自定义节点（P0）
| 功能项 | 优先级 | 说明 |
|--------|--------|------|
| 节点类型注册 | P0 | 注册 Device 和 System 两种节点 |
| Vue 组件集成 | P0 | 使用 @antv/x6-vue-shape 渲染节点 |
| 节点数据模型 | P0 | 定义 TypeScript 类型约束 |
| 节点样式系统 | P0 | 正常/悬停/选中/错误状态样式 |
| 容器最小尺寸 | P0 | System 节点的尺寸约束 |

### 3.3 Phase 3 - 拖拽交互（P0）
| 功能项 | 优先级 | 说明 |
|--------|--------|------|
| 左侧物料面板 | P0 | 展示可拖拽的节点类型 |
| 拖拽至画布 | P0 | Dnd 插件集成 |
| zIndex 管理 | P0 | 子节点始终在父节点上方 |
| 入组检测 | P0 | 节点中心点进入容器触发高亮 |
| 入组执行 | P0 | 建立父子关系并转换坐标 |
| 出组检测 | P0 | 节点外溢超过 50% 触发出组 |

### 3.4 Phase 4 - 容器扩容（P0）
| 功能项 | 优先级 | 说明 |
|--------|--------|------|
| 包围盒计算 | P0 | 实时计算子节点并集区域 |
| 动态填充 | P0 | 四周预留 40px Padding |
| 防抖优化 | P0 | 100ms 防抖避免频繁计算 |
| 父子联动 | P0 | 容器移动带动子节点平移 |
| 空容器保护 | P0 | 无子节点时保持最小尺寸 |

### 3.5 Phase 5 - 布局算法（P1）
| 功能项 | 优先级 | 说明 |
|--------|--------|------|
| Dagre 布局集成 | P1 | 层级有向图布局 |
| Grid 布局集成 | P1 | 网格对齐布局 |
| 局部整理 | P1 | 仅对选中容器内部布局 |
| 锁定机制 | P1 | isManual 标记保护手动布局 |
| 布局工具栏 | P1 | 触发不同布局算法的按钮 |

### 3.6 Phase 6 - 业务集成（P1）
| 功能项 | 优先级 | 说明 |
|--------|--------|------|
| 双击事件 | P1 | 区分设备/容器触发不同弹窗 |
| 设备编辑弹窗 | P1 | Element Plus Dialog 表单 |
| 容器编辑弹窗 | P1 | 系统名称、属性编辑 |
| 数据持久化 | P1 | 导出/导入 JSON 格式 |
| 状态视觉反馈 | P1 | 错误状态红色边框闪烁 |

### 3.7 Phase 7 - 性能优化（P1）
| 功能项 | 优先级 | 说明 |
|--------|--------|------|
| markRaw 优化 | P1 | 阻止 Vue 深度监听 Graph 实例 |
| 虚拟滚动 | P2 | 大规模节点场景优化 |
| Web Worker 计算 | P2 | 复杂布局算法异步计算 |
| 事件清理 | P1 | 组件销毁时移除监听器 |
| FPS 监控 | P2 | 性能监控埋点 |

---

## 4. 实施步骤概览

### 4.1 步骤依赖关系
```
Step 1 (基础画布)
    ↓
Step 2 (自定义节点)
    ↓
Step 3 (拖拽功能) ← 依赖 Step 1 + Step 2
    ↓
Step 4 (容器扩容) ← 依赖 Step 3
    ↓
Step 5 (布局算法) ← 可并行于 Step 4
    ↓
Step 6 (业务集成) ← 依赖 Step 2
    ↓
Step 7 (性能优化) ← 依赖所有前置步骤
```

### 4.2 步骤详情

| 步骤 | 文档 | 优先级 | 工时 | 关键产出 |
|------|------|--------|------|----------|
| Step 1 | [01-基础画布搭建.md](./01-基础画布搭建.md) | P0 | 1 天 | 可拖拽缩放的画布 |
| Step 2 | [02-自定义节点系统.md](./02-自定义节点系统.md) | P0 | 2 天 | Device 和 System 节点 |
| Step 3 | [03-拖拽交互实现.md](./03-拖拽交互实现.md) | P0 | 2.5 天 | 入组/出组逻辑 |
| Step 4 | [04-容器自动扩容.md](./04-容器自动扩容.md) | P0 | 2 天 | 动态包围盒计算 |
| Step 5 | [05-布局算法集成.md](./05-布局算法集成.md) | P1 | 2 天 | Dagre/Grid 布局 |
| Step 6 | [06-业务数据扩展.md](./06-业务数据扩展.md) | P1 | 2 天 | 数据模型与持久化 |
| Step 7 | [07-性能优化调优.md](./07-性能优化调优.md) | P1 | 2 天 | 性能监控与优化 |

**总工时**：约 13.5 天（约 3 周）

---

## 5. 技术架构设计

### 5.1 分层架构
```
┌─────────────────────────────────────┐
│   Presentation Layer (展示层)       │
│   - Vue Components                   │
│   - Element Plus UI                  │
└─────────────────────────────────────┘
              ↕
┌─────────────────────────────────────┐
│   Business Logic Layer (业务层)     │
│   - Composables (useGraph, etc.)    │
│   - Event Handlers                   │
└─────────────────────────────────────┘
              ↕
┌─────────────────────────────────────┐
│   Data Layer (数据层)                │
│   - Pinia Store                      │
│   - Local Storage                    │
└─────────────────────────────────────┘
              ↕
┌─────────────────────────────────────┐
│   Rendering Layer (渲染层)          │
│   - @antv/x6 Graph Engine           │
│   - @antv/x6-vue-shape              │
└─────────────────────────────────────┘
```

### 5.2 目录结构
```
src/
├── components/
│   ├── canvas/
│   │   ├── GraphCanvas.vue          # 画布主组件
│   │   ├── Toolbar.vue              # 工具栏
│   │   └── Stencil.vue              # 左侧物料面板
│   ├── nodes/
│   │   ├── DeviceNode.vue           # 设备节点
│   │   └── SystemContainer.vue      # 系统容器
│   └── dialogs/
│       ├── DeviceDialog.vue         # 设备编辑弹窗
│       └── SystemDialog.vue         # 系统编辑弹窗
├── composables/
│   ├── useGraph.ts                  # Graph 实例管理
│   ├── useLayout.ts                 # 布局算法
│   ├── useAutoExpand.ts             # 容器扩容
│   ├── useNodeDrop.ts               # 入组/出组
│   └── useNodeEvents.ts             # 事件管理
├── stores/
│   └── graphStore.ts                # 图数据状态
├── utils/
│   ├── graphConfig.ts               # Graph 配置
│   ├── nodeRegistry.ts              # 节点注册
│   └── coordinateTransform.ts       # 坐标转换
└── types/
    ├── graph.d.ts                   # 图相关类型
    └── node.d.ts                    # 节点数据类型
```

### 5.3 数据流设计
```
User Interaction (用户操作)
    ↓
X6 Event (node:move, node:dblclick)
    ↓
Composable Handler (useNodeEvents)
    ↓
Business Logic (计算、校验)
    ↓
Pinia Store Update (更新状态)
    ↓
Vue Re-render (响应式更新)
    ↓
X6 Graph Sync (视图同步)
```

---

## 6. 质量保证策略

### 6.1 代码质量
- **TypeScript 严格模式**：启用 `strict: true`
- **ESLint 规则**：强制代码风格统一
- **Prettier 格式化**：自动格式化代码
- **代码审查**：关键模块 Peer Review

### 6.2 测试策略
- **单元测试**：核心工具函数（坐标转换、包围盒计算）
- **集成测试**：入组/出组逻辑完整流程
- **性能测试**：500+ 节点压力测试
- **兼容性测试**：Chrome/Firefox/Edge 浏览器

### 6.3 文档规范
- **接口文档**：所有公共方法添加 JSDoc 注释
- **组件文档**：说明 Props、Events、Slots
- **架构文档**：保持与代码实现同步更新

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 能够从左侧面板拖拽设备节点至画布
- [ ] 设备节点能够拖入系统容器并建立父子关系
- [ ] 系统容器随子节点变化自动扩容
- [ ] 设备节点拖离容器时自动出组
- [ ] 双击设备节点弹出编辑弹窗
- [ ] 双击系统容器弹出系统编辑弹窗
- [ ] 工具栏触发 Dagre 布局生效
- [ ] 局部整理仅对选中容器内部生效
- [ ] 锁定的节点不参与自动布局
- [ ] 画布数据可导出为 JSON 并重新导入

### 7.2 性能验收
- [ ] 500 节点画布保持 60 FPS
- [ ] 容器扩容计算延迟 < 100ms
- [ ] 拖拽操作无明显卡顿
- [ ] 画布初始化加载时间 < 2s

### 7.3 体验验收
- [ ] 网格吸附感明显
- [ ] 对齐线自动显示
- [ ] 容器入组反馈及时（高亮效果）
- [ ] 节点层级关系正确（子节点在父节点上方）
- [ ] 错误状态可视化反馈清晰

---

## 8. 里程碑与交付物

### 8.1 里程碑规划
```
Week 1 (Day 1-5)
├── M1: 基础画布搭建完成
├── M2: 自定义节点系统完成
└── 交付物：可添加节点的画布

Week 2 (Day 6-10)
├── M3: 拖拽交互实现完成
├── M4: 容器自动扩容完成
└── 交付物：支持入组/出组的容器系统

Week 3 (Day 11-15)
├── M5: 布局算法集成完成
├── M6: 业务数据扩展完成
├── M7: 性能优化调优完成
└── 交付物：完整的生产级图形化布局系统
```

### 8.2 最终交付物清单
- [ ] 完整的源代码（通过 ESLint 和 TypeScript 检查）
- [ ] 单元测试覆盖率 > 70%
- [ ] 技术文档（架构设计、API 文档）
- [ ] 用户操作手册
- [ ] 性能测试报告
- [ ] 部署文档

---

## 9. 风险预案

### 9.1 技术风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 容器扩容性能问题 | 高 | 高 | 防抖 + Web Worker |
| 坐标转换错误 | 中 | 高 | 编写单元测试验证 |
| 大规模节点卡顿 | 中 | 中 | 虚拟滚动 + 按需渲染 |

### 9.2 进度风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| X6 API 学习曲线 | 中 | 中 | 预留 1 天调研时间 |
| 布局算法调试复杂 | 中 | 低 | 降低为 P1 优先级 |

---

## 10. 后续规划

### 10.1 短期优化（1-2 个月）
- 增加更多节点类型（数据库、网关等）
- 支持连接线编辑
- 增加快捷键操作
- 支持撤销/重做功能

### 10.2 中期扩展（3-6 个月）
- 多人协同编辑（WebSocket）
- 版本历史管理
- 模板库功能
- 智能推荐连接关系

### 10.3 长期愿景（6-12 个月）
- 3D 可视化集成
- AI 辅助布局
- 跨平台支持（移动端）

---

**文档版本**：1.0.0  
**创建时间**：2026-02-09  
**负责人**：待指派  
**审核状态**：待评审
