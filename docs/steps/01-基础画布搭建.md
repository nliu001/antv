# Step 1 - 基础画布搭建

## 目录
- [1. 步骤概述](#1-步骤概述)
- [2. 目标与产出](#2-目标与产出)
- [3. 技术方案](#3-技术方案)
- [4. 实现任务拆解](#4-实现任务拆解)
- [5. 关键技术点](#5-关键技术点)
- [6. 数据结构设计](#6-数据结构设计)
- [7. 组件设计](#7-组件设计)
- [8. 测试要点](#8-测试要点)
- [9. 验收标准](#9-验收标准)
- [10. 注意事项](#10-注意事项)

---

## 1. 步骤概述

### 1.1 当前步骤定位
这是整个图形化布局系统的**第一步**，也是**基础核心**。本步骤将搭建起可交互的画布基础设施，为后续的节点渲染、拖拽交互、布局算法等功能提供底层支撑。

### 1.2 前置依赖

#### 1.2.1 技术栈要求
- Vue 3 + TypeScript 项目已初始化
- Pinia 状态管理已配置

#### 1.2.2 依赖包安装
```bash
# 核心依赖
npm install @antv/x6

# 对齐线插件（必需）
npm install @antv/x6-plugin-snapline
```

#### 1.2.3 目标浏览器
- Chrome 64+
- Edge 79+（基于 Chromium）

#### 1.2.4 目标平台
- 仅支持桌面端浏览器
- 不支持移动端触摸设备

### 1.3 后续依赖关系
```
Step 1 (基础画布) 
    ↓ 提供画布实例
Step 2 (自定义节点) - 需要在画布上渲染
    ↓
Step 3 (拖拽功能) - 需要画布事件系统
```

---

## 2. 目标与产出

### 2.1 功能目标
- ✅ 创建可交互的无限画布
- ✅ 支持鼠标滚轮缩放（Ctrl + 滚轮）
- ✅ 支持空白区域拖拽平移
- ✅ 启用网格吸附（10px 步长）
- ✅ 启用对齐线辅助
- ✅ 提供工具栏（放大/缩小/适应画布）

### 2.2 交付产出
1. **组件文件**
   - `src/components/canvas/GraphCanvas.vue` - 画布主组件
   - `src/components/canvas/Toolbar.vue` - 工具栏组件

2. **Composable 文件**
   - `src/composables/useGraph.ts` - Graph 实例管理逻辑

3. **配置文件**
   - `src/utils/graphConfig.ts` - Graph 初始化配置

4. **类型定义文件**
   - `src/types/graph.d.ts` - Graph 相关类型定义

5. **Store 文件**
   - `src/stores/graphStore.ts` - 图数据状态管理

---

## 3. 技术方案

### 3.1 技术选型
| 技术项 | 方案 | 理由 |
|--------|------|------|
| 画布引擎 | @antv/x6 | 成熟的图编辑引擎 |
| 实例管理 | Composable API | 逻辑复用与解耦 |
| 状态管理 | Pinia Store | 跨组件状态共享 |
| 性能优化 | markRaw | 避免 Vue 深度监听 Graph |

### 3.2 架构设计
```
GraphCanvas.vue (画布容器组件)
    ↓ 创建
useGraph.ts (画布实例管理)
    ↓ 初始化
Graph Instance (X6 实例)
    ↓ 注入
graphStore (Pinia 状态管理)
    ↓ 同步
Toolbar.vue (工具栏组件)
```

### 3.3 Graph 配置策略
- **网格系统**：10px 步长，线状网格（mesh），浅色显示
- **交互策略**：空白区域直接拖拽，框选禁用（后续步骤启用）
- **缩放范围**：0.2 ~ 3 倍（20% ~ 300%）
- **对齐线**：动态显示，不启用磁吸（避免与网格冲突）
- **背景色**：浅灰色（#F5F5F5）

**网格类型选择说明**：
- 采用线状网格（mesh）而非点状网格（dot）
- 理由：设备拓扑图场景下，线状网格提供更清晰的空间参考
- 便于用户目测节点间距和对齐关系

---

## 4. 实现任务拆解

### 4.1 任务清单
| 任务编号 | 任务名称 | 优先级 | 预估工时 | 依赖 |
|---------|---------|--------|----------|------|
| T1-1 | 创建 Graph 配置文件 | P0 | 0.5h | 无 |
| T1-2 | 定义 Graph 类型定义 | P0 | 0.5h | 无 |
| T1-3 | 实现 useGraph Composable | P0 | 1.5h | T1-1, T1-2 |
| T1-4 | 创建 graphStore | P0 | 0.5h | 无 |
| T1-5 | 实现 GraphCanvas 组件 | P0 | 3h | T1-3, T1-4 |
| T1-6 | 实现 Toolbar 组件 | P0 | 1h | T1-5 |
| T1-7 | 集成到 App.vue | P0 | 0.5h | T1-5, T1-6 |
| T1-8 | 测试画布交互功能 | P0 | 2h | T1-7 |

**总工时**：约 9.5 小时（1.2 个工作日）

### 4.2 实施顺序
```
Phase 1: 基础配置 (T1-1, T1-2, T1-4)
    ↓
Phase 2: 逻辑实现 (T1-3)
    ↓
Phase 3: 组件开发 (T1-5, T1-6)
    ↓
Phase 4: 集成测试 (T1-7, T1-8)
```

---

## 5. 关键技术点

### 5.1 Graph 初始化配置

#### 5.1.1 配置项说明
- **container**：挂载的 DOM 容器
- **width/height**：画布尺寸（跟随容器自适应）
- **background**：背景配置
- **grid**：网格配置
- **snapline**：对齐线配置
- **scroller**：滚动配置
- **mousewheel**：缩放配置
- **panning**：平移配置

#### 5.1.2 关键参数
```typescript
{
  // 网格系统
  grid: {
    size: 10,        // 10px 步长
    visible: true,   // 显示网格
    type: 'mesh'     // 线状网格（更适合拓扑图）
  },
  
  // 对齐线
  snapline: {
    enabled: true,
    sharp: false,    // 禁用磁吸（避免与网格冲突）
    tolerance: 10    // 对齐线显示距离
  },
  
  // 缩放
  mousewheel: {
    enabled: true,
    modifiers: ['ctrl', 'meta'],  // Ctrl + 滚轮（Mac 用 Cmd）
    minScale: 0.2,   // 最小 20%
    maxScale: 3,     // 最大 300%
    factor: 1.1      // 每次缩放 10%
  },
  
  // 平移
  panning: {
    enabled: true
    // 不设置 modifiers，允许空白区域直接拖拽
  }
}
```

### 5.2 实例生命周期管理

#### 5.2.1 创建时机
- 在 `onMounted` 钩子中创建 Graph 实例
- 确保 DOM 容器已渲染完成

#### 5.2.2 销毁时机
- 在 `onBeforeUnmount` 钩子中销毁实例
- 移除所有事件监听器
- 释放内存资源

#### 5.2.3 markRaw 优化
使用 Vue 3 的 `markRaw` 标记 Graph 实例，避免 Vue 对其进行深度响应式监听，提升性能。

### 5.3 画布自适应

#### 5.3.1 容器尺寸监听
使用 `ResizeObserver` 监听容器尺寸变化，动态调整画布大小。

#### 5.3.2 响应式调整
当窗口大小变化时，画布自动重新计算尺寸并重绘。

---

## 6. 数据结构设计

### 6.1 Graph Store 结构
```typescript
interface GraphState {
  // Graph 实例（使用 markRaw）
  graph: Graph | null
  
  // 初始化状态
  isInitialized: boolean
  isLoading: boolean
  error: Error | null
  
  // 画布缩放比例
  zoom: number
  
  // 画布中心点坐标
  centerPoint: { x: number; y: number }
  
  // 交互状态
  isInteracting: boolean
  isPanning: boolean
  isZooming: boolean
}
```

### 6.2 Graph Actions
```typescript
interface GraphActions {
  // 设置 Graph 实例
  setGraph(graph: Graph): void
  
  // 更新缩放比例
  updateZoom(zoom: number): void
  
  // 放大
  zoomIn(factor?: number): void
  
  // 缩小
  zoomOut(factor?: number): void
  
  // 适应画布
  zoomToFit(): void
  
  // 居中显示
  centerContent(): void
  
  // 清空画布
  clearGraph(): void
}
```

---

## 7. 组件设计

### 7.1 GraphCanvas 组件

#### 7.1.1 组件职责
- 提供画布容器 DOM
- 初始化 Graph 实例
- 管理实例生命周期
- 监听画布事件并同步到 Store

#### 7.1.2 Props 定义
```typescript
interface GraphCanvasProps {
  // 画布高度（默认：100%）
  height?: string | number
  
  // 画布宽度（默认：100%）
  width?: string | number
  
  // 是否显示网格（默认：true）
  showGrid?: boolean
  
  // 是否启用对齐线（默认：true）
  enableSnapline?: boolean
}
```

**使用前提**：
- 父容器必须有明确的宽度和高度
- 如果父容器未设置尺寸，`100%` 会导致画布高度/宽度为 0
- 建议在 App.vue 中为容器设置 `width: 100vw; height: 100vh
```

#### 7.1.3 Emits 定义
```typescript
interface GraphCanvasEmits {
  // Graph 实例创建完成
  'graph-ready': (graph: Graph) => void
  
  // 画布缩放变化
  'zoom-change': (zoom: number) => void
  
  // 画布被点击
  'canvas-click': (event: MouseEvent) => void
}
```

### 7.2 Toolbar 组件

#### 7.2.1 组件职责
- 提供画布操作按钮
- 触发缩放、适应画布等操作
- 显示当前缩放比例

#### 7.2.2 功能按钮
- **放大**：zoomIn
- **缩小**：zoomOut
- **适应画布**：zoomToFit（调用 X6 原生方法）
- **实际大小**：zoomTo(1)（重置为 100% 缩放）

**说明**：
- 所有按钮仅支持鼠标点击触发
- 不提供快捷键支持（避免与浏览器快捷键冲突）
- `zoomToFit` 在空画布时采用 X6 默认行为（不执行操作）

#### 7.2.3 Props 定义
```typescript
interface ToolbarProps {
  // 工具栏位置（默认：top-right）
  position?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right'
  
  // 是否显示缩放比例文本
  showZoomText?: boolean
}
```

---

## 8. 测试要点

### 8.1 功能测试
- [ ] 画布能够正常渲染并占满容器
- [ ] 鼠标滚轮 + Ctrl 能够缩放画布
- [ ] 空白区域拖拽能够平移画布
- [ ] 网格线清晰可见
- [ ] 工具栏按钮触发正确的缩放操作
- [ ] 适应画布功能正常（空画布时不报错）

### 8.2 交互测试
- [ ] 缩放时画布内容居中缩放
- [ ] 缩放范围限制在 0.1 ~ 5 倍
- [ ] 平移时画布流畅无卡顿
- [ ] 快速缩放不出现渲染闪烁

### 8.3 边界测试
- [ ] 窗口大小变化时画布自适应
- [ ] 组件销毁时 Graph 实例正确释放
- [ ] 重复创建/销毁组件无内存泄漏
- [ ] 最小化/最大化窗口画布正常

---

## 9. 验收标准

### 9.1 功能验收
- ✅ 画布能够正常渲染
- ✅ 网格吸附功能生效（拖动时有磁吸感）
- ✅ 对齐线在适当时机显示
- ✅ 缩放范围控制在 0.1 ~ 5 倍
- ✅ 工具栏所有按钮功能正常
- ✅ Store 中的 zoom 值与实际缩放同步

### 9.2 性能验收
- ✅ 画布初始化时间 < 500ms
- ✅ 缩放操作响应时间 < 50ms
- ✅ 平移操作保持 60 FPS

### 9.3 代码质量验收
- ✅ 通过 ESLint 检查
- ✅ 通过 TypeScript 编译
- ✅ 所有公共方法添加 JSDoc 注释
- ✅ 组件 Props 有完整的类型定义

---

## 10. 注意事项

### 10.1 性能优化
1. **markRaw 必须使用**
   - Graph 实例必须用 `markRaw` 包裹
   - 避免 Vue 对 X6 内部状态进行响应式追踪

2. **防抖优化**
   - 窗口 resize 事件需要防抖处理
   - 建议防抖延迟 150ms（与容器扩容保持一致）

3. **事件清理**
   - 组件销毁时必须调用 `graph.dispose()`
   - 移除所有自定义事件监听器

4. **错误处理**
   - Graph 初始化失败时需要 catch 错误
   - 更新 Store 中的 error 状态
   - 显示友好的错误提示

### 10.2 开发规范
1. **类型安全**
   - 所有 Graph 相关方法必须有类型定义
   - 避免使用 `any` 类型

2. **错误处理**
   - Graph 初始化失败时需要 catch 错误
   - 提供友好的错误提示

3. **命名规范**
   - 组件使用 PascalCase
   - Composable 使用 useXxx 命名
   - Store 使用 xxxStore 命名

### 10.3 调试技巧
1. **开启 X6 调试模式**
   - 在开发环境开启 `graph.options.debug = true`
   - 查看控制台的 X6 日志

2. **查看 Graph 状态**
   - 使用 `graph.toJSON()` 导出当前状态
   - 使用 `graph.fromJSON()` 恢复状态

3. **性能监控**
   - 使用 Chrome DevTools Performance 分析渲染性能
   - 关注 FPS 和内存占用

### 10.4 常见问题

#### Q1: 画布不显示？
**A**: 检查父容器是否有明确的高度和宽度。
- GraphCanvas 的 Props 默认为 `100%`
- 如果父容器未设置尺寸，会导致画布高度/宽度为 0
- 建议在 App.vue 中设置容器样式：`width: 100vw; height: 100vh`

#### Q2: 缩放后内容偏移？
**A**: 检查是否设置了正确的 `transformOrigin`，建议使用画布中心点。

#### Q3: 内存泄漏？
**A**: 确保在组件销毁时调用 `graph.dispose()` 并移除事件监听。

#### Q4: 网格线不显示？
**A**: 检查 `grid.visible` 是否为 `true`，背景色是否与网格色冲突。

---

## 11. 后续步骤预告

完成本步骤后，将进入 **Step 2 - 自定义节点系统**，届时将：
- 注册设备节点（Device）和系统容器（System）
- 使用 Vue 组件渲染节点
- 定义节点数据模型

**关键衔接点**：
- 本步骤创建的 `graph` 实例将在 Step 2 中用于注册节点
- `graphStore` 将在 Step 2 中扩展节点管理功能

---

**文档版本**：1.1.0  
**创建时间**：2026-02-09  
**最后更新**：2026-02-09  
**预估工时**：1.2 天（9.5 小时）  
**优先级**：P0（必须完成）  
**变更记录**：
- v1.1.0: 根据问题澄清更新配置参数、移除全屏和快捷键功能、优化工时估算
