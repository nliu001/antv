# Step 2 - 自定义节点系统

## 目录
- [1. 步骤概述](#1-步骤概述)
- [2. 目标与产出](#2-目标与产出)
- [3. 技术方案](#3-技术方案)
- [4. 实现任务拆解](#4-实现任务拆解)
- [5. 节点类型设计](#5-节点类型设计)
- [6. 数据模型设计](#6-数据模型设计)
- [7. 组件设计](#7-组件设计)
- [8. 节点注册流程](#8-节点注册流程)
- [9. 测试要点](#9-测试要点)
- [10. 验收标准](#10-验收标准)
- [11. 注意事项](#11-注意事项)

---

## 1. 步骤概述

### 1.1 当前步骤定位
这是图形化布局系统的**第二步**，将在画布上构建自定义的节点类型系统。本步骤将定义两种核心节点：**设备节点（Device）**和**系统容器（System）**，并使用 Vue 组件化方式渲染节点内容。

### 1.2 前置依赖
- ✅ Step 1：基础画布已搭建完成
- ✅ 已安装 `@antv/x6-vue-shape` 依赖（Vue 3 版本 >= 3.0.0）
- ✅ Graph 实例已可用

**重要说明**：
- X6 3.x + Vue 3 使用 `@antv/x6-vue-shape@^3.0.0`（正式包）
- `@antv/x6-vue3-shape` 是旧的非官方包（不推荐）

### 1.3 后续依赖关系
```
Step 1 (基础画布)
    ↓
Step 2 (自定义节点) ← 当前步骤
    ↓ 提供节点类型
Step 3 (拖拽功能) - 需要拖拽节点至画布
    ↓
Step 6 (业务集成) - 需要节点数据模型
```

---

## 2. 目标与产出

### 2.1 功能目标
- ✅ 注册设备节点（Device）类型
- ✅ 注册系统容器（System）类型
- ✅ 使用 Vue 组件渲染节点内容
- ✅ 定义完整的节点数据模型
- ✅ 支持节点状态样式（正常/悬停/选中/错误）
- ✅ 容器节点支持父子关系
- ✅ 支持通过工具栏添加节点到画布（临时测试功能）

### 2.2 交付产出
1. **组件文件**
   - `src/components/nodes/DeviceNode.vue` - 设备节点组件
   - `src/components/nodes/SystemContainer.vue` - 系统容器组件

2. **工具文件**
   - `src/utils/nodeRegistry.ts` - 节点注册工具
   - `src/utils/nodeFactory.ts` - 节点工厂函数

3. **类型定义文件**
   - `src/types/node.d.ts` - 节点数据类型定义

4. **Store 扩展**
   - 扩展 `graphStore.ts` - 增加节点管理功能

5. **配置文件**
   - `src/config/nodeConfig.ts` - 节点默认配置

---

## 3. 技术方案

### 3.1 技术选型
| 技术项 | 方案 | 理由 |
|--------|------|------|
| 节点渲染 | @antv/x6-vue3-shape | 支持 Vue 3 组件化渲染 |
| 节点类型 | Shape 继承机制 | X6 原生节点类型系统 |
| 数据模型 | TypeScript Interface | 类型安全与智能提示 |
| 样式管理 | attrs 配置 + Scoped CSS | 分离结构与样式 |

### 3.2 架构设计
```
nodeRegistry.ts (注册节点类型)
    ↓ 注册
X6 Shape Registry (X6 节点类型系统)
    ↓ 创建
DeviceNode / SystemContainer (Vue 组件)
    ↓ 渲染
Graph Canvas (画布显示)
```

### 3.3 节点类型继承关系
```
X6 基础 Shape (Rect)
    ↓ 继承
Custom Shape (device-node / system-container)
    ↓ 使用
Vue Component (DeviceNode.vue / SystemContainer.vue)
```

---

## 4. 实现任务拆解

### 4.1 任务清单
| 任务编号 | 任务名称 | 优先级 | 预估工时 | 依赖 |
|---------|---------|--------|----------|------|
| T2-1 | 确认 @antv/x6-vue-shape 版本 >= 3.0.0 | P0 | 0.5h | 无 |
| T2-2 | 定义节点数据类型 | P0 | 1h | 无 |
| T2-3 | 创建节点配置文件 | P0 | 0.5h | T2-2 |
| T2-4 | 实现 DeviceNode 组件 | P0 | 2h | T2-2 |
| T2-5 | 实现 SystemContainer 组件 | P0 | 2h | T2-2 |
| T2-6 | 实现节点注册工具 | P0 | 2h | T2-4, T2-5 |
| T2-7 | 实现节点工厂函数 | P0 | 1h | T2-6 |
| T2-8 | 扩展 graphStore 节点管理 | P0 | 1h | T2-7 |
| T2-9 | 在工具栏添加测试按钮 | P0 | 1h | T2-8 |
| T2-10 | 测试节点渲染与交互 | P0 | 2h | T2-9 |

**总工时**：约 12.5 小时（1.6 个工作日）

### 4.2 实施顺序
```
Phase 1: 环境准备 (T2-1, T2-2, T2-3)
    ↓
Phase 2: 组件开发 (T2-4, T2-5)
    ↓
Phase 3: 注册系统 (T2-6, T2-7)
    ↓
Phase 4: Store 集成 (T2-8, T2-9)
    ↓
Phase 5: 测试验证 (T2-10)
```

---

## 5. 节点类型设计

### 5.1 设备节点（Device Node）

#### 5.1.1 节点特征
- **用途**：表示单个设备（服务器、交换机、路由器等）
- **视觉**：图标 + 名称 + 状态指示器
- **尺寸**：固定尺寸（120px × 80px）
- **交互**：可拖拽、可选中、可双击编辑
- **父子关系**：可作为容器的子节点

#### 5.1.2 节点组成
```
┌─────────────────────┐
│   [图标]           │  ← 设备类型图标
│                     │
│   设备名称          │  ← 设备名称（可编辑）
│                     │
│   [●] 状态          │  ← 状态指示器（运行中/停止/异常）
└─────────────────────┘
```

#### 5.1.3 状态样式
- **正常态**：灰色边框，白色背景
- **悬停态**：蓝色边框，浅蓝背景
- **选中态**：蓝色粗边框，阴影效果
- **错误态**：红色边框，红色闪烁动画

### 5.2 系统容器（System Container）

#### 5.2.1 节点特征
- **用途**：逻辑分组，包含多个设备节点
- **视觉**：虚线边框 + 标题栏 + 子节点区域
- **尺寸**：动态尺寸（最小 200px × 150px）
- **交互**：可拖拽、可选中、可双击编辑、可嵌入子节点
- **父子关系**：可包含多个设备节点

#### 5.2.2 节点组成
```
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
  [系统图标] 系统名称         ← 标题栏
│                             │
                               
│  ┌────┐  ┌────┐            │
   │设备1│  │设备2│             ← 子节点区域
│  └────┘  └────┘            │
                               
│                             │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
```

#### 5.2.3 状态样式
- **正常态**：灰色虚线边框，透明背景
- **悬停态**：蓝色虚线边框，浅蓝半透明背景
- **选中态**：蓝色粗虚线边框
- **入组高亮**：蓝色实线边框，高亮背景（临时状态）

---

## 6. 数据模型设计

### 6.1 基础节点数据类型
```typescript
/**
 * 节点类型枚举
 */
enum NodeType {
  DEVICE = 'device',      // 设备节点
  SYSTEM = 'system'       // 系统容器
}

/**
 * 设备类型枚举
 */
enum DeviceType {
  SERVER = 'server',      // 服务器
  SWITCH = 'switch',      // 交换机
  ROUTER = 'router',      // 路由器
  FIREWALL = 'firewall',  // 防火墙
  STORAGE = 'storage'     // 存储设备
}

/**
 * 节点状态枚举
 */
enum NodeStatus {
  NORMAL = 'normal',      // 正常
  WARNING = 'warning',    // 警告
  ERROR = 'error',        // 错误
  OFFLINE = 'offline'     // 离线
}
```

### 6.2 设备节点数据模型
```typescript
/**
 * 设备节点数据
 */
interface DeviceNodeData {
  // 节点类型
  type: NodeType.DEVICE
  
  // 设备类型
  deviceType: DeviceType
  
  // 设备名称
  name: string
  
  // 设备状态
  status: NodeStatus
  
  // 设备 IP 地址
  ip?: string
  
  // 设备端口号
  port?: number
  
  // 是否手动布局（锁定位置）
  isManual: boolean
  
  // 业务自定义数据
  businessData?: Record<string, any>
  
  // 创建时间
  createdAt: string
  
  // 更新时间
  updatedAt: string
}
```

### 6.3 系统容器数据模型
```typescript
/**
 * 系统容器数据
 */
interface SystemNodeData {
  // 节点类型
  type: NodeType.SYSTEM
  
  // 系统名称
  name: string
  
  // 系统描述
  description?: string
  
  // 最小宽度
  minWidth: number
  
  // 最小高度
  minHeight: number
  
  // 内边距
  padding: number
  
  // 是否自动扩容
  autoExpand: boolean
  
  // 子节点 ID 列表
  childrenIds: string[]
  
  // 业务自定义数据
  businessData?: Record<string, any>
  
  // 创建时间
  createdAt: string
  
  // 更新时间
  updatedAt: string
}
```

### 6.4 节点配置类型
```typescript
/**
 * 节点创建配置
 */
interface NodeCreateOptions {
  // 节点 ID（可选，不传则自动生成）
  id?: string
  
  // 节点位置
  position: { x: number; y: number }
  
  // 节点尺寸（容器节点必传）
  size?: { width: number; height: number }
  
  // 节点数据
  data: DeviceNodeData | SystemNodeData
  
  // 父节点 ID（可选）
  parentId?: string
  
  // 初始 zIndex（可选）
  zIndex?: number
}
```

---

## 7. 组件设计

### 7.1 DeviceNode 组件

#### 7.1.1 组件职责
- 渲染设备图标、名称、状态
- 响应鼠标悬停、选中状态
- 根据设备类型显示不同图标
- 根据状态显示不同颜色

#### 7.1.2 Props 定义

**方式一：使用 inject（推荐）**
```typescript
import { inject } from 'vue'
import type { Node, Graph } from '@antv/x6'

// X6 Vue3 Shape 会自动注入 node 和 graph
const node = inject<Node>('node')
const graph = inject<Graph>('graph')

// 访问节点数据
const nodeData = node?.getData() as DeviceNodeData
```

**方式二：使用 defineProps（也支持）**
```typescript
interface DeviceNodeProps {
  node?: Node<DeviceNodeData>
  graph?: Graph
}

const props = defineProps<DeviceNodeProps>()
```

#### 7.1.3 计算属性
- `iconName`：根据 deviceType 返回对应图标名称
- `statusColor`：根据 status 返回对应颜色
- `displayName`：处理过长名称的截断显示

#### 7.1.4 样式要点
- 使用 Flexbox 布局（垂直居中对齐）
- 图标使用 Element Plus Icon
- 状态指示器使用 CSS 动画（错误状态闪烁）
- 响应式字体大小（支持缩放）

### 7.2 SystemContainer 组件

#### 7.2.1 组件职责
- 渲染容器标题栏和边框
- 提供子节点放置区域
- 显示子节点数量提示
- 支持标题编辑（双击）

#### 7.2.2 Props 定义

**方式一：使用 inject（推荐）**
```typescript
import { inject } from 'vue'
import type { Node, Graph } from '@antv/x6'

// X6 Vue3 Shape 会自动注入 node 和 graph
const node = inject<Node>('node')
const graph = inject<Graph>('graph')

// 访问节点数据
const nodeData = node?.getData() as SystemNodeData
```

**方式二：使用 defineProps（也支持）**
```typescript
interface SystemContainerProps {
  node?: Node<SystemNodeData>
  graph?: Graph
}

const props = defineProps<SystemContainerProps>()
```

#### 7.2.3 计算属性
- `childrenCount`：子节点数量
- `isEmpty`：是否为空容器
- `containerStyle`：动态容器样式

#### 7.2.4 样式要点
- 虚线边框（dashed border）
- 半透明背景（rgba）
- 标题栏固定在顶部
- 子节点区域占据剩余空间
- 空容器显示提示文字（"拖拽设备至此处"）

---

## 8. 节点注册流程

### 8.1 注册步骤

#### 8.1.1 在应用启动时引入 Vue Shape
在 `main.ts` 中导入 `@antv/x6-vue-shape` 包（必须在创建 Graph 之前）：

```typescript
// main.ts
import { createApp } from 'vue'
import '@antv/x6-vue-shape'  // ⭐ 必须导入，初始化 Vue Shape 支持
import App from './App.vue'

const app = createApp(App)
app.mount('#app')
```

#### 8.1.2 注册设备节点
使用 `register` 函数注册 Device 节点类型：

```typescript
import { register } from '@antv/x6-vue-shape'
import DeviceNode from '@/components/nodes/DeviceNode.vue'

register({
  shape: 'device-node',
  width: 120,
  height: 80,
  component: DeviceNode
})
```

#### 8.1.3 注册系统容器
使用 `register` 函数注册 System 节点类型：

```typescript
import { register } from '@antv/x6-vue-shape'
import SystemContainer from '@/components/nodes/SystemContainer.vue'

register({
  shape: 'system-container',
  width: 200,
  height: 150,
  component: SystemContainer
})
```

#### 8.1.4 配置默认属性
在注册时可以直接设置默认的 attrs、ports 等配置。

### 8.2 节点注册配置

#### 8.2.1 设备节点配置
```typescript
import { register } from '@antv/x6-vue-shape'
import DeviceNode from '@/components/nodes/DeviceNode.vue'

register({
  shape: 'device-node',
  width: 120,
  height: 80,
  component: DeviceNode,
  attrs: {
    body: {
      fill: '#ffffff',
      stroke: '#d9d9d9',
      strokeWidth: 1,
      rx: 4,
      ry: 4
    }
  },
  ports: {
    // 连接桩配置（后续步骤扩展）
    items: []
  }
})
```

#### 8.2.2 系统容器配置
```typescript
import { register } from '@antv/x6-vue3-shape'
import SystemContainer from '@/components/nodes/SystemContainer.vue'

register({
  shape: 'system-container',
  width: 200,
  height: 150,
  component: SystemContainer,
  attrs: {
    body: {
      fill: 'transparent',
      stroke: '#d9d9d9',
      strokeWidth: 2,
      strokeDasharray: '5,5',  // 虚线
      rx: 8,
      ry: 8
    }
  },
  zIndex: 0  // 容器默认在底层
})
```

### 8.3 节点工厂函数

#### 8.3.1 createDeviceNode
根据传入的配置创建设备节点实例。

#### 8.3.2 createSystemContainer
根据传入的配置创建系统容器实例。

#### 8.3.3 工厂函数特点
- 自动生成唯一 ID
- 填充默认数据
- 设置创建时间戳
- 返回节点实例引用

---

## 9. 测试要点

### 9.1 功能测试
- [ ] 设备节点能够正常渲染
- [ ] 系统容器能够正常渲染
- [ ] 不同设备类型显示不同图标
- [ ] 不同状态显示不同颜色
- [ ] 容器标题栏正确显示
- [ ] 空容器显示提示文字
- [ ] 通过工具栏按钮能添加节点

### 9.2 样式测试
- [ ] 节点样式符合设计规范
- [ ] 悬停时样式正确变化
- [ ] 选中时样式正确变化
- [ ] 错误状态闪烁动画流畅
- [ ] 画布缩放时节点内容自适应

### 9.3 数据测试
- [ ] 节点数据正确存储在 node.data 中
- [ ] 节点 ID 自动生成且唯一
- [ ] 时间戳正确记录
- [ ] Store 中节点列表正确更新

### 9.4 边界测试
- [ ] 节点名称超长时正确截断
- [ ] 容器最小尺寸限制生效
- [ ] 大量节点（100+）渲染性能正常
- [ ] 节点删除后数据正确清理

---

## 10. 验收标准

### 10.1 功能验收
- ✅ 能够通过工具栏按钮添加设备节点
- ✅ 能够通过工具栏按钮添加系统容器
- ✅ 节点显示正确的图标和名称
- ✅ 节点状态正确反映在视觉上
- ✅ 容器显示正确的标题和边框
- ✅ 节点可以被选中和拖动

### 10.2 代码质量验收
- ✅ 通过 ESLint 检查
- ✅ 通过 TypeScript 编译
- ✅ 所有接口有完整的类型定义
- ✅ 组件有清晰的 JSDoc 注释
- ✅ 数据模型符合规范

### 10.3 性能验收
- ✅ 单个节点渲染时间 < 50ms
- ✅ 100 个节点渲染时间 < 2s
- ✅ 节点交互无明显延迟

---

## 11. 注意事项

### 11.1 Vue Shape 使用要点

#### 11.1.1 组件隔离
- Vue Shape 组件运行在独立的上下文中
- 需要通过 `inject('node')` 或 `inject('graph')` 获取实例
- 需要通过 `node.getData()` 访问节点数据

#### 11.1.2 性能优化
- 避免在组件中使用复杂的计算属性
- 避免频繁更新 node.data
- 使用 v-once 优化静态内容

#### 11.1.3 样式作用域
- 使用 scoped 样式避免全局污染
- 注意 z-index 层级关系
- 响应式布局适配缩放

### 11.2 数据管理要点

#### 11.2.1 数据持久化
- 所有业务数据存储在 node.data 中
- 不在 Vue 组件内部维护状态
- 数据变更通过 X6 API 操作

#### 11.2.2 数据同步
- Node 数据变化时同步到 Store
- Store 数据变化时同步到 Node
- 避免循环更新

#### 11.2.3 数据校验
- 创建节点前校验数据完整性
- 使用 TypeScript 强制类型约束
- 提供数据迁移机制（版本升级）

### 11.3 常见问题

#### Q1: Vue 组件内部状态不更新？
**A**: 
- 使用 `inject('node')` 获取节点实例
- 通过 `node.getData()` 访问数据，通过 `node.setData()` 更新数据
- 避免在组件内部维护状态，数据应存储在 `node.data` 中

#### Q2: 节点图标不显示？
**A**: 确保 Element Plus 图标已全局注册，或在组件内单独引入。

#### Q3: 节点样式被覆盖？
**A**: 检查 CSS 优先级，使用 scoped 样式或增加选择器权重。

#### Q4: 容器尺寸不正确？
**A**: 确保在创建时传入 size 参数，或设置了 minWidth/minHeight。

### 11.4 开发建议

#### 11.4.1 组件复用
- 提取公共样式为 SCSS 变量
- 提取公共逻辑为 Composable
- 图标组件独立封装

#### 11.4.2 类型定义
- 为所有数据模型定义接口
- 为工厂函数定义参数类型
- 使用泛型约束节点类型

#### 11.4.3 测试驱动
- 先定义数据模型和接口
- 再实现组件和逻辑
- 最后编写测试用例

---

## 12. 后续步骤预告

完成本步骤后，将进入 **Step 3 - 拖拽交互实现**，届时将：
- 创建左侧物料面板
- 实现从物料面板拖拽节点至画布
- 实现设备入组/出组容器逻辑
- 管理节点 zIndex 层级

**关键衔接点**：
- 本步骤创建的节点类型将在 Step 3 中被拖拽
- 节点数据模型将在 Step 3 中扩展父子关系字段

---

**文档版本**：1.1.0  
**创建时间**：2026-02-09  
**最后更新**：2026-02-09  
**预估工时**：1.6 天（13 小时）  
**优先级**：P0（必须完成）  
**变更记录**：
- v1.1.0: 修正 Vue3 Shape 依赖和 API 使用方式，调整工时估算
