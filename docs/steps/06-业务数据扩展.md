# Step 6 - 业务数据扩展

## 目录
- [1. 步骤概述](#1-步骤概述)
- [2. 目标与产出](#2-目标与产出)
- [3. 技术方案](#3-技术方案)
- [4. 实现任务拆解](#4-实现任务拆解)
- [5. 数据模型设计](#5-数据模型设计)
- [6. 编辑弹窗实现](#6-编辑弹窗实现)
- [7. 数据持久化](#7-数据持久化)
- [8. 状态视觉反馈](#8-状态视觉反馈)
- [9. 测试要点](#9-测试要点)
- [10. 验收标准](#10-验收标准)
- [11. 注意事项](#11-注意事项)

---

## 1. 步骤概述

### 1.1 当前步骤定位
这是图形化布局系统的**第六步**，将节点系统与业务数据深度集成。本步骤实现双击节点触发编辑弹窗、扩展业务数据模型、数据持久化（导入/导出）、以及基于业务状态的视觉反馈。

### 1.2 前置依赖
- ✅ Step 1-5：所有基础功能已完成
- ✅ Element Plus 已集成
- ✅ 节点数据模型已定义

### 1.3 后续依赖关系
```
Step 5 (布局算法)
    ↓
Step 6 (业务数据扩展) ← 当前步骤
    ↓ 提供完整业务系统
Step 7 (性能优化) - 优化数据处理性能
```

---

## 2. 目标与产出

### 2.1 功能目标
- ✅ 双击设备节点触发设备编辑弹窗
- ✅ 双击系统容器触发系统编辑弹窗
- ✅ 扩展节点业务数据模型
- ✅ 实现表单验证
- ✅ 实现数据持久化（LocalStorage）
- ✅ 实现导入/导出 JSON 功能
- ✅ 实现状态视觉反馈（错误状态红色闪烁）
- ✅ 实现节点删除功能
- ✅ 实现批量操作（可选）

### 2.2 交付产出
1. **组件文件**
   - `src/components/dialogs/DeviceDialog.vue` - 设备编辑弹窗
   - `src/components/dialogs/SystemDialog.vue` - 系统编辑弹窗
   - `src/components/dialogs/ImportDialog.vue` - 导入数据弹窗
   - `src/components/dialogs/ExportDialog.vue` - 导出数据弹窗

2. **Composable 文件**
   - `src/composables/useNodeDialog.ts` - 弹窗管理逻辑
   - `src/composables/usePersistence.ts` - 数据持久化逻辑

3. **工具文件**
   - `src/utils/dataExport.ts` - 数据导出工具
   - `src/utils/dataImport.ts` - 数据导入工具
   - `src/utils/dataValidation.ts` - 数据验证工具

4. **Store 扩展**
   - 扩展 `graphStore.ts` - 增加业务数据管理

5. **类型定义**
   - 扩展 `src/types/business.d.ts` - 业务数据类型

---

## 3. 技术方案

### 3.1 技术选型
| 技术项 | 方案 | 理由 |
|--------|------|------|
| 弹窗组件 | Element Plus Dialog | 成熟的 UI 组件 |
| 表单验证 | Element Plus Form | 内置验证规则 |
| 数据持久化 | LocalStorage | 浏览器本地存储 |
| 导入导出 | JSON 格式 | 易读易解析 |

### 3.2 架构设计
```
用户双击节点
    ↓
X6 Event (node:dblclick)
    ↓
useNodeDialog (判断节点类型)
    ↓
DeviceDialog / SystemDialog (显示弹窗)
    ↓
用户编辑数据
    ↓
表单验证
    ↓
更新节点数据 (node.setData)
    ↓
触发视觉更新
    ↓
自动保存到 LocalStorage
```

### 3.3 数据流设计
```
Graph 节点数据 (node.data)
    ↕ 双向同步
Pinia Store (graphStore)
    ↕ 双向同步
LocalStorage (持久化)
    ↕ 导入/导出
JSON 文件 (用户保存)
```

---

## 4. 实现任务拆解

### 4.1 任务清单
| 任务编号 | 任务名称 | 优先级 | 预估工时 | 依赖 |
|---------|---------|--------|----------|------|
| T6-1 | 扩展业务数据类型定义 | P0 | 1h | 无 |
| T6-2 | 实现设备编辑弹窗 | P0 | 3h | T6-1 |
| T6-3 | 实现系统编辑弹窗 | P0 | 2h | T6-1 |
| T6-4 | 实现双击事件处理 | P0 | 1.5h | T6-2, T6-3 |
| T6-5 | 实现表单验证逻辑 | P0 | 2h | T6-2, T6-3 |
| T6-6 | 实现数据持久化 | P0 | 2.5h | T6-5 |
| T6-7 | 实现导入功能 | P1 | 2h | T6-6 |
| T6-8 | 实现导出功能 | P1 | 1.5h | T6-6 |
| T6-9 | 实现状态视觉反馈 | P1 | 2h | T6-5 |
| T6-10 | 实现节点删除功能 | P0 | 1.5h | 无 |
| T6-11 | 测试业务功能 | P0 | 2h | T6-10 |

**总工时**：约 21 小时（3 个工作日）

### 4.2 实施顺序
```
Phase 1: 数据模型 (T6-1)
    ↓
Phase 2: 编辑弹窗 (T6-2, T6-3, T6-4, T6-5)
    ↓
Phase 3: 持久化 (T6-6, T6-7, T6-8)
    ↓
Phase 4: 视觉反馈 (T6-9, T6-10)
    ↓
Phase 5: 测试验证 (T6-11)
```

---

## 5. 数据模型设计

### 5.1 扩展设备节点数据

#### 5.1.1 基础字段（已有）
```typescript
interface DeviceNodeData {
  type: NodeType.DEVICE
  deviceType: DeviceType
  name: string
  status: NodeStatus
  isManual: boolean
  createdAt: string
  updatedAt: string
}
```

#### 5.1.2 业务字段（新增）
```typescript
interface DeviceNodeData {
  // ... 基础字段
  
  // 设备 IP 地址
  ip: string
  
  // 设备端口
  port: number
  
  // 设备描述
  description: string
  
  // 设备规格
  specs: {
    cpu?: string      // CPU 型号
    memory?: string   // 内存大小
    storage?: string  // 存储容量
    network?: string  // 网络配置
  }
  
  // 设备负责人
  owner: {
    name: string      // 姓名
    email?: string    // 邮箱
    phone?: string    // 电话
  }
  
  // 设备标签
  tags: string[]
  
  // 设备备注
  notes: string
  
  // 监控数据（可选）
  monitoring?: {
    cpuUsage?: number     // CPU 使用率
    memoryUsage?: number  // 内存使用率
    diskUsage?: number    // 磁盘使用率
    status?: NodeStatus   // 实时状态
  }
  
  // 业务自定义数据
  customData: Record<string, any>
}
```

### 5.2 扩展系统容器数据

#### 5.2.1 基础字段（已有）
```typescript
interface SystemNodeData {
  type: NodeType.SYSTEM
  name: string
  minWidth: number
  minHeight: number
  padding: number
  autoExpand: boolean
  childrenIds: string[]
  createdAt: string
  updatedAt: string
}
```

#### 5.2.2 业务字段（新增）
```typescript
interface SystemNodeData {
  // ... 基础字段
  
  // 系统描述
  description: string
  
  // 系统版本
  version: string
  
  // 系统环境
  environment: 'dev' | 'test' | 'staging' | 'prod'
  
  // 系统负责人
  owner: {
    name: string
    email?: string
    phone?: string
  }
  
  // 系统配置
  config: {
    // 系统域名
    domain?: string
    
    // 系统端口
    port?: number
    
    // 其他配置
    [key: string]: any
  }
  
  // 系统标签
  tags: string[]
  
  // 系统备注
  notes: string
  
  // 业务自定义数据
  customData: Record<string, any>
}
```

---

## 6. 编辑弹窗实现

### 6.1 设备编辑弹窗

#### 6.1.1 表单结构
```
┌────────────────────────────────────┐
│  编辑设备                          │
├────────────────────────────────────┤
│  基础信息                          │
│  ┌────────────────────────────┐  │
│  │ 设备名称: [_____________]  │  │
│  │ 设备类型: [下拉选择____]   │  │
│  │ 设备状态: [下拉选择____]   │  │
│  │ IP 地址:  [_____________]  │  │
│  │ 端口:     [_____________]  │  │
│  └────────────────────────────┘  │
│                                    │
│  规格信息 (可折叠)                 │
│  ┌────────────────────────────┐  │
│  │ CPU:     [_____________]   │  │
│  │ 内存:    [_____________]   │  │
│  │ 存储:    [_____________]   │  │
│  └────────────────────────────┘  │
│                                    │
│  负责人信息 (可折叠)               │
│  ┌────────────────────────────┐  │
│  │ 姓名:    [_____________]   │  │
│  │ 邮箱:    [_____________]   │  │
│  │ 电话:    [_____________]   │  │
│  └────────────────────────────┘  │
│                                    │
│  [取消]              [保存]        │
└────────────────────────────────────┘
```

#### 6.1.2 表单验证规则
```typescript
const deviceFormRules = {
  name: [
    { required: true, message: '请输入设备名称', trigger: 'blur' },
    { min: 2, max: 50, message: '长度在 2 到 50 个字符', trigger: 'blur' }
  ],
  deviceType: [
    { required: true, message: '请选择设备类型', trigger: 'change' }
  ],
  ip: [
    { required: true, message: '请输入 IP 地址', trigger: 'blur' },
    {
      pattern: /^(\d{1,3}\.){3}\d{1,3}$/,
      message: 'IP 地址格式不正确',
      trigger: 'blur'
    }
  ],
  port: [
    { required: true, message: '请输入端口号', trigger: 'blur' },
    {
      type: 'number',
      min: 1,
      max: 65535,
      message: '端口号范围 1-65535',
      trigger: 'blur'
    }
  ],
  'owner.email': [
    {
      type: 'email',
      message: '邮箱格式不正确',
      trigger: 'blur'
    }
  ]
}
```

### 6.2 系统编辑弹窗

#### 6.2.1 表单结构
```
┌────────────────────────────────────┐
│  编辑系统                          │
├────────────────────────────────────┤
│  基础信息                          │
│  ┌────────────────────────────┐  │
│  │ 系统名称: [_____________]  │  │
│  │ 系统版本: [_____________]  │  │
│  │ 运行环境: [单选按钮组___]  │  │
│  │ 系统描述: [文本域_______]  │  │
│  └────────────────────────────┘  │
│                                    │
│  配置信息 (可折叠)                 │
│  ┌────────────────────────────┐  │
│  │ 域名:    [_____________]   │  │
│  │ 端口:    [_____________]   │  │
│  └────────────────────────────┘  │
│                                    │
│  [取消]              [保存]        │
└────────────────────────────────────┘
```

#### 6.2.2 表单验证规则
```typescript
const systemFormRules = {
  name: [
    { required: true, message: '请输入系统名称', trigger: 'blur' },
    { min: 2, max: 50, message: '长度在 2 到 50 个字符', trigger: 'blur' }
  ],
  environment: [
    { required: true, message: '请选择运行环境', trigger: 'change' }
  ],
  'config.domain': [
    {
      pattern: /^[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+$/,
      message: '域名格式不正确',
      trigger: 'blur'
    }
  ]
}
```

### 6.3 弹窗交互

#### 6.3.1 打开弹窗
```typescript
function openNodeDialog(node: Node) {
  const data = node.getData()
  
  if (data.type === NodeType.DEVICE) {
    deviceDialogVisible.value = true
    deviceFormData.value = { ...data }  // 深拷贝
    currentNode.value = node
  } else if (data.type === NodeType.SYSTEM) {
    systemDialogVisible.value = true
    systemFormData.value = { ...data }
    currentNode.value = node
  }
}
```

#### 6.3.2 保存数据
```typescript
async function saveNodeData() {
  // 1. 表单验证
  await formRef.value.validate()
  
  // 2. 更新时间戳
  formData.value.updatedAt = new Date().toISOString()
  
  // 3. 更新节点数据
  currentNode.value.setData(formData.value)
  
  // 4. 同步到 Store
  graphStore.updateNodeData(currentNode.value.id, formData.value)
  
  // 5. 触发视觉更新
  updateNodeVisual(currentNode.value)
  
  // 6. 自动保存到 LocalStorage
  saveToPersistence()
  
  // 7. 关闭弹窗
  dialogVisible.value = false
  
  // 8. 提示成功
  ElMessage.success('保存成功')
}
```

---

## 7. 数据持久化

### 7.1 LocalStorage 存储

#### 7.1.1 存储结构
```typescript
interface PersistenceData {
  // 画布数据
  graph: {
    zoom: number
    centerPoint: { x: number; y: number }
  }
  
  // 节点数据
  nodes: Array<{
    id: string
    shape: string
    position: { x: number; y: number }
    size: { width: number; height: number }
    data: DeviceNodeData | SystemNodeData
    zIndex: number
    parent?: string
  }>
  
  // 边数据（可选）
  edges: Array<{
    id: string
    source: string
    target: string
    data?: any
  }>
  
  // 元数据
  metadata: {
    version: string
    createdAt: string
    updatedAt: string
  }
}
```

#### 7.1.2 保存逻辑
```typescript
function saveToLocalStorage() {
  const data: PersistenceData = {
    graph: {
      zoom: graphStore.zoom,
      centerPoint: graphStore.centerPoint
    },
    nodes: graph.getNodes().map(node => ({
      id: node.id,
      shape: node.shape,
      position: node.position(),
      size: node.size(),
      data: node.getData(),
      zIndex: node.getZIndex(),
      parent: node.getParent()?.id
    })),
    edges: graph.getEdges().map(edge => ({
      id: edge.id,
      source: edge.getSourceCellId(),
      target: edge.getTargetCellId(),
      data: edge.getData()
    })),
    metadata: {
      version: '1.0.0',
      createdAt: existingData?.metadata.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString()
    }
  }
  
  localStorage.setItem('graph-data', JSON.stringify(data))
}
```

#### 7.1.3 加载逻辑
```typescript
function loadFromLocalStorage() {
  const dataStr = localStorage.getItem('graph-data')
  if (!dataStr) return
  
  try {
    const data: PersistenceData = JSON.parse(dataStr)
    
    // 1. 恢复画布状态
    graphStore.updateZoom(data.graph.zoom)
    
    // 2. 清空当前画布
    graph.clearCells()
    
    // 3. 恢复节点
    data.nodes.forEach(nodeData => {
      const node = graph.addNode({
        id: nodeData.id,
        shape: nodeData.shape,
        x: nodeData.position.x,
        y: nodeData.position.y,
        width: nodeData.size.width,
        height: nodeData.size.height,
        data: nodeData.data,
        zIndex: nodeData.zIndex
      })
      
      // 恢复父子关系
      if (nodeData.parent) {
        const parent = graph.getCellById(nodeData.parent)
        if (parent) {
          parent.addChild(node)
        }
      }
    })
    
    // 4. 恢复边
    data.edges.forEach(edgeData => {
      graph.addEdge({
        id: edgeData.id,
        source: edgeData.source,
        target: edgeData.target,
        data: edgeData.data
      })
    })
    
    ElMessage.success('数据加载成功')
  } catch (error) {
    console.error('加载数据失败:', error)
    ElMessage.error('数据加载失败')
  }
}
```

### 7.2 导入导出功能

#### 7.2.1 导出为 JSON
```typescript
function exportToJSON() {
  const data = generatePersistenceData()
  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: 'application/json'
  })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `graph-${Date.now()}.json`
  a.click()
  URL.revokeObjectURL(url)
  
  ElMessage.success('导出成功')
}
```

#### 7.2.2 从 JSON 导入
```typescript
function importFromJSON(file: File) {
  const reader = new FileReader()
  
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result as string)
      
      // 验证数据格式
      validateImportData(data)
      
      // 加载数据
      loadGraphData(data)
      
      ElMessage.success('导入成功')
    } catch (error) {
      console.error('导入失败:', error)
      ElMessage.error('导入失败，请检查文件格式')
    }
  }
  
  reader.readAsText(file)
}
```

---

## 8. 状态视觉反馈

### 8.1 状态映射

#### 8.1.1 状态颜色
```typescript
const STATUS_COLORS = {
  [NodeStatus.NORMAL]: '#52c41a',   // 绿色
  [NodeStatus.WARNING]: '#faad14',  // 橙色
  [NodeStatus.ERROR]: '#ff4d4f',    // 红色
  [NodeStatus.OFFLINE]: '#d9d9d9'   // 灰色
}
```

#### 8.1.2 应用样式
```typescript
function updateNodeVisual(node: Node) {
  const data = node.getData()
  const color = STATUS_COLORS[data.status]
  
  node.attr('body/stroke', color)
  
  // 错误状态添加闪烁动画
  if (data.status === NodeStatus.ERROR) {
    node.attr('body/strokeWidth', 3)
    node.addClass('error-blink')
  } else {
    node.attr('body/strokeWidth', 1)
    node.removeClass('error-blink')
  }
}
```

### 8.2 闪烁动画

#### 8.2.1 CSS 动画
```css
@keyframes error-blink {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.error-blink {
  animation: error-blink 1s infinite;
}
```

---

## 9. 测试要点

### 9.1 功能测试
- [ ] 双击设备节点弹出设备编辑弹窗
- [ ] 双击系统容器弹出系统编辑弹窗
- [ ] 表单验证生效
- [ ] 数据保存成功并更新节点
- [ ] LocalStorage 自动保存
- [ ] 刷新页面后数据恢复
- [ ] 导出 JSON 成功
- [ ] 导入 JSON 成功
- [ ] 状态变化触发视觉反馈
- [ ] 节点删除成功

### 9.2 交互测试
- [ ] 弹窗打开关闭流畅
- [ ] 表单输入响应及时
- [ ] 验证错误提示明确
- [ ] 保存成功提示友好

### 9.3 边界测试
- [ ] 导入格式错误的 JSON 有提示
- [ ] LocalStorage 满了有降级方案
- [ ] 大量数据（1000+ 节点）导入导出正常

---

## 10. 验收标准

### 10.1 功能验收
- ✅ 双击节点能触发编辑弹窗
- ✅ 表单验证正确
- ✅ 数据保存成功
- ✅ 数据持久化生效
- ✅ 导入导出功能正常
- ✅ 状态视觉反馈正确

### 10.2 代码质量验收
- ✅ 通过 ESLint 检查
- ✅ 通过 TypeScript 编译
- ✅ 数据验证有完整逻辑

---

## 11. 注意事项

### 11.1 数据安全
- 敏感数据加密存储
- 导入数据需验证
- 避免 XSS 注入

### 11.2 性能优化
- 大数据导入使用分批处理
- LocalStorage 定期清理

---

**文档版本**：1.0.0  
**创建时间**：2026-02-09  
**预估工时**：3 天  
**优先级**：P1（重要）
