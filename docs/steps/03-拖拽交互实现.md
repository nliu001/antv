# Step 3 - 拖拽交互实现

## 目录
- [1. 步骤概述](#1-步骤概述)
- [2. 目标与产出](#2-目标与产出)
- [3. 技术方案](#3-技术方案)
- [4. 实现任务拆解](#4-实现任务拆解)
- [5. 物料面板设计](#5-物料面板设计)
- [6. 拖拽系统设计](#6-拖拽系统设计)
- [7. 入组出组逻辑](#7-入组出组逻辑)
- [8. zIndex 管理策略](#8-zindex-管理策略)
- [9. 坐标转换处理](#9-坐标转换处理)
- [10. 测试要点](#10-测试要点)
- [11. 验收标准](#11-验收标准)
- [12. 注意事项](#12-注意事项)

---

## 1. 步骤概述

### 1.1 当前步骤定位
这是图形化布局系统的**第三步**，也是**核心交互**的关键步骤。本步骤将实现从物料面板拖拽节点至画布、设备节点入组/出组系统容器、节点层级管理等核心交互功能。

### 1.2 前置依赖
- ✅ Step 1：基础画布已搭建
- ✅ Step 2：自定义节点系统已实现
- ✅ Graph 实例支持拖拽事件
- ✅ 节点类型已注册

### 1.3 后续依赖关系
```
Step 2 (自定义节点)
    ↓
Step 3 (拖拽交互) ← 当前步骤
    ↓ 提供入组机制
Step 4 (容器扩容) - 需要父子关系
    ↓
Step 5 (布局算法) - 需要节点组织结构
```

---

## 2. 目标与产出

### 2.1 功能目标
- ✅ 创建左侧物料面板（Stencil）
- ✅ 支持从物料面板拖拽节点至画布
- ✅ 实现设备节点入组容器的检测与执行
- ✅ 实现设备节点出组容器的检测与执行
- ✅ 自动管理节点 zIndex 层级
- ✅ 处理绝对坐标与相对坐标转换
- ✅ 提供入组视觉反馈（高亮效果）

### 2.2 交付产出
1. **组件文件**
   - `src/components/canvas/Stencil.vue` - 物料面板组件
   - `src/components/canvas/StencilItem.vue` - 物料项组件

2. **Composable 文件**
   - `src/composables/useNodeDrop.ts` - 节点拖放逻辑
   - `src/composables/useZIndexManager.ts` - zIndex 管理
   - `src/composables/useParentChild.ts` - 父子关系管理

3. **工具文件**
   - `src/utils/coordinateTransform.ts` - 坐标转换工具
   - `src/utils/nodeDetection.ts` - 节点检测工具

4. **常量文件**
   - `src/constants/drag.ts` - 拖拽相关常量

---

## 3. 技术方案

### 3.1 技术选型
| 技术项 | 方案 | 理由 |
|--------|------|------|
| 拖拽实现 | @antv/x6 内置 Dnd 类 | X6 3.x 已内置插件，直接导入 |
| 入组检测 | 包围盒碰撞检测 | 基于 BBox 的几何运算 |
| 坐标转换 | 矩阵变换 | 支持多层嵌套 |
| 视觉反馈 | attrs 动态修改 | 实时高亮效果 |

### 3.2 架构设计
```
Stencil Panel (物料面板)
    ↓ 拖拽开始
Dnd Plugin (拖拽插件)
    ↓ 拖拽中
useNodeDrop (检测入组)
    ↓ 放下
useParentChild (建立父子关系)
    ↓ 坐标转换
coordinateTransform (坐标工具)
    ↓ 层级管理
useZIndexManager (z轴排序)
```

### 3.3 交互流程设计
```
用户操作流程：
1. 从物料面板拖拽节点
2. 移动到画布上方
3. 实时预览节点位置
4. 移入容器触发高亮（200ms 延迟）
5. 松手放置节点
6. 自动建立父子关系
7. 更新 zIndex 层级
```

---

## 4. 实现任务拆解

### 4.1 任务清单
| 任务编号 | 任务名称 | 优先级 | 预估工时 | 依赖 |
|---------|---------|--------|----------|------|
| T3-1 | 确认 Dnd 和 Stencil 插件可用性 | P0 | 0.5h | 无 |
| T3-2 | 创建物料面板组件 | P0 | 2.5h | T3-1 |
| T3-3 | 集成 Dnd 插件 | P0 | 1.5h | T3-2 |
| T3-4 | 实现坐标转换工具 | P0 | 2h | 无 |
| T3-5 | 实现入组检测逻辑 | P0 | 3h | T3-4 |
| T3-6 | 实现出组检测逻辑 | P0 | 2h | T3-5 |
| T3-7 | 实现父子关系管理 | P0 | 2h | T3-5, T3-6 |
| T3-8 | 实现 zIndex 管理器 | P0 | 1.5h | 无 |
| T3-9 | 集成入组视觉反馈 | P0 | 1.5h | T3-5 |
| T3-10 | 测试拖拽与入组功能 | P0 | 2h | T3-9 |

**总工时**：约 18.5 小时（2.3 个工作日）

### 4.2 实施顺序
```
Phase 1: 基础拖拽 (T3-1, T3-2, T3-3)
    ↓
Phase 2: 坐标系统 (T3-4)
    ↓
Phase 3: 入组逻辑 (T3-5, T3-7, T3-9)
    ↓
Phase 4: 出组逻辑 (T3-6)
    ↓
Phase 5: 层级管理 (T3-8)
    ↓
Phase 6: 集成测试 (T3-10)
```

---

## 5. 物料面板设计

### 5.0 实现方案选择

**方案 A：使用 Stencil（推荐）**
- ✅ X6 官方组件，功能完整
- ✅ 内置分组、搜索、拖拽
- ✅ 样式可自定义
- ⚠️ 需要额外的 DOM 容器

```typescript
import { Stencil } from '@antv/x6'

const stencil = new Stencil({
  target: graph,
  title: '物料面板',
  groups: [
    { name: 'device', title: '设备分组' },
    { name: 'container', title: '容器分组' }
  ]
})
```

**方案 B：自定义 Vue 组件 + Dnd**
- ✅ 完全自定义 UI
- ✅ 更灵活的交互
- ⚠️ 需要手动实现分组、搜索等功能
- ⚠️ 开发工时增加

**本文档采用**：方案 B（自定义 Vue 组件），以便更好地与 Element Plus UI 集成。

### 5.1 面板布局

#### 5.1.1 整体结构
```
┌─────────────────────┐
│  物料面板            │  ← 标题栏
├─────────────────────┤
│                     │
│  [设备分组]          │  ← 分组标题
│  ┌────┐  ┌────┐    │
│  │服务器│  │交换机│  │  ← 可拖拽项
│  └────┘  └────┘    │
│                     │
│  [容器分组]          │
│  ┌────┐             │
│  │系统 │             │
│  └────┘             │
│                     │
└─────────────────────┘
```

#### 5.1.2 物料项配置
```typescript
interface StencilItemConfig {
  // 唯一标识
  id: string
  
  // 显示名称
  label: string
  
  // 图标名称
  icon: string
  
  // 节点类型
  nodeType: NodeType
  
  // 设备类型（设备节点专用）
  deviceType?: DeviceType
  
  // 默认数据
  defaultData: Partial<DeviceNodeData | SystemNodeData>
}
```

### 5.2 面板功能

#### 5.2.1 物料项渲染
- 显示图标和名称
- 支持悬停提示
- 可拖拽标识（鼠标样式）

#### 5.2.2 分组管理
- 设备分组：服务器、交换机、路由器、防火墙、存储
- 容器分组：系统容器
- 支持折叠/展开（可选）

#### 5.2.3 搜索功能（可选）
- 快速筛选物料项
- 高亮匹配结果

---

## 6. 拖拽系统设计

### 6.1 Dnd 插件配置

#### 6.1.1 插件初始化
需要在 Graph 实例创建后初始化 Dnd 插件。

**重要说明**：X6 3.x 已将所有插件内置到主包中，无需额外安装依赖。

**正确导入方式**：
```typescript
import { Dnd } from '@antv/x6'

// 创建 Dnd 实例
const dnd = new Dnd({
  target: graph,
  scaled: true,
  animation: true
})
```

#### 6.1.2 关键配置项
```typescript
// 使用 X6 3.x 内置的 Dnd
import { Dnd } from '@antv/x6'

const dnd = new Dnd({
  // 拖拽目标（画布实例）
  target: graph,
  
  // 拖拽时是否缩放节点
  scaled: true,
  
  // 拖拽动画配置
  animation: true,
  
  // 拖拽验证（是否允许放置）
  validateNode: (droppingNode, options) => {
    // 自定义验证逻辑
    return true
  },
  
  // 获取拖拽数据
  getDragNode: (sourceNode) => {
    // 返回待拖拽的节点
    return sourceNode.clone()
  },
  
  // 获取放置位置
  getDropNode: (draggingNode) => {
    // 返回最终放置的节点
    return draggingNode
  }
})
```

### 6.2 拖拽生命周期

#### 6.2.1 拖拽开始（dragStart）
- 克隆物料项节点
- 设置拖拽预览样式
- 显示拖拽光标

#### 6.2.2 拖拽中（dragging）
- 实时更新节点位置
- 检测是否进入容器
- 显示高亮反馈

#### 6.2.3 拖拽结束（dragEnd）
- 创建真实节点
- 建立父子关系（如果入组）
- 清除拖拽状态
- 触发事件通知

### 6.3 拖拽约束

#### 6.3.1 位置约束
- 不允许放置在画布外
- 吸附到网格点
- 避免与现有节点重叠（可选）

#### 6.3.2 类型约束
- 设备节点可拖入容器
- 容器不能拖入其他容器（单层嵌套）
- 节点不能拖入自身

---

## 7. 入组出组逻辑

### 7.1 入组机制

#### 7.1.1 检测条件
- **几何条件**：设备节点中心点进入容器的包围盒范围
- **时间条件**：停留时间 > 200ms（防误触）
- **类型条件**：仅设备节点可入组
- **层级条件**：节点当前无父节点

#### 7.1.2 检测流程
```
1. 监听 node:mousemove 事件
    ↓
2. 获取设备节点中心点坐标
    ↓
3. 遍历画布上所有容器节点
    ↓
4. 检测中心点是否在容器 BBox 内
    ↓
5. 如果在容器内，启动 200ms 定时器
    ↓
6. 定时器触发，容器高亮（入组意图确认）
    ↓
7. 如果移出容器，清除定时器和高亮
```

#### 7.1.3 执行操作
```
1. 获取设备节点当前位置（绝对坐标）
    ↓
2. 获取容器节点位置（绝对坐标）
    ↓
3. 计算相对坐标 = 设备坐标 - 容器坐标
    ↓
4. 调用 container.addChild(device)
    ↓
5. 设置设备节点新位置（相对坐标）
    ↓
6. 更新设备节点 zIndex（高于容器）
    ↓
7. 更新数据模型（容器的 childrenIds）
    ↓
8. 触发入组事件
```

### 7.2 出组机制

#### 7.2.1 检测条件
- **几何条件**：设备节点外溢容器超过 50% 面积
- **持续条件**：外溢状态持续 > 100ms
- **类型条件**：仅已入组的设备节点可出组

#### 7.2.2 检测流程
```
1. 监听 node:change:position 事件
    ↓
2. 检查节点是否有父节点
    ↓
3. 计算节点与父容器的重叠面积
    ↓
4. 如果重叠面积 < 50%，标记为出组意图
    ↓
5. 启动 100ms 定时器
    ↓
6. 定时器触发，执行出组操作
```

#### 7.2.3 执行操作
```
1. 获取设备节点当前位置（相对坐标）
    ↓
2. 获取容器节点位置（绝对坐标）
    ↓
3. 计算新绝对坐标 = 相对坐标 + 容器坐标
    ↓
4. 调用 container.removeChild(device)
    ↓
5. 设置设备节点新位置（绝对坐标）
    ↓
6. 更新设备节点 zIndex（恢复正常层级）
    ↓
7. 更新数据模型（容器的 childrenIds）
    ↓
8. 触发出组事件
```

### 7.3 视觉反馈

#### 7.3.1 入组反馈
- **容器高亮**：边框颜色变为蓝色（#1890ff）
- **边框加粗**：strokeWidth 从 2 增加到 3
- **背景变化**：fill 从 transparent 变为浅蓝色半透明
- **动画效果**：0.2s 过渡动画

#### 7.3.2 出组反馈
- **节点闪烁**：短暂的缩放动画（scale 1.1 → 1.0）
- **容器恢复**：容器样式恢复正常

---

## 8. zIndex 管理策略

### 8.1 层级规则

#### 8.1.1 基础规则
- **容器节点**：zIndex = 0（底层）
- **独立设备节点**：zIndex = 10（中层）
- **容器内设备节点**：zIndex = parent.zIndex + 10（高于父容器）
- **选中节点**：zIndex = 999（临时最顶层）
- **拖拽中节点**：zIndex = 1000（最顶层）

#### 8.1.2 动态调整
```typescript
// 拖拽开始时
onNodeMouseDown(node) {
  originalZIndex = node.getZIndex()
  node.setZIndex(1000)
}

// 拖拽结束时
onNodeMouseUp(node) {
  if (node.hasParent()) {
    node.setZIndex(parent.getZIndex() + 10)
  } else {
    node.setZIndex(originalZIndex)
  }
}
```

### 8.2 zIndex 管理器

#### 8.2.1 管理器职责
- 自动计算节点应有的 zIndex
- 批量更新节点层级
- 处理层级冲突
- 提供层级查询接口

#### 8.2.2 关键方法
```typescript
interface ZIndexManager {
  // 获取节点应有的 zIndex
  getNodeZIndex(node: Node): number
  
  // 将节点置于顶层
  bringToFront(node: Node): void
  
  // 将节点置于底层
  sendToBack(node: Node): void
  
  // 更新子树的 zIndex
  updateChildrenZIndex(parent: Node): void
  
  // 重置所有节点的 zIndex
  resetAllZIndex(): void
}
```

---

## 9. 坐标转换处理

### 9.1 坐标系统

#### 9.1.1 坐标类型
- **绝对坐标（Global）**：相对于画布原点的坐标
- **相对坐标（Local）**：相对于父节点原点的坐标
- **屏幕坐标（Screen）**：相对于浏览器视口的坐标

#### 9.1.2 转换场景
- **入组时**：绝对坐标 → 相对坐标
- **出组时**：相对坐标 → 绝对坐标
- **拖拽时**：屏幕坐标 → 绝对坐标

### 9.2 转换算法

#### 9.2.1 入组坐标转换
```typescript
/**
 * 将设备节点的绝对坐标转换为相对父容器的坐标
 */
function toLocalCoordinate(
  devicePosition: { x: number; y: number },
  containerPosition: { x: number; y: number }
): { x: number; y: number } {
  return {
    x: devicePosition.x - containerPosition.x,
    y: devicePosition.y - containerPosition.y
  }
}
```

#### 9.2.2 出组坐标转换
```typescript
/**
 * 将设备节点的相对坐标转换为绝对坐标
 */
function toGlobalCoordinate(
  localPosition: { x: number; y: number },
  containerPosition: { x: number; y: number }
): { x: number; y: number } {
  return {
    x: localPosition.x + containerPosition.x,
    y: localPosition.y + containerPosition.y
  }
}
```

#### 9.2.3 包围盒检测
```typescript
/**
 * 检测点是否在包围盒内
 */
function isPointInBBox(
  point: { x: number; y: number },
  bbox: { x: number; y: number; width: number; height: number }
): boolean {
  return (
    point.x >= bbox.x &&
    point.x <= bbox.x + bbox.width &&
    point.y >= bbox.y &&
    point.y <= bbox.y + bbox.height
  )
}

/**
 * 计算两个包围盒的重叠面积
 */
function calculateOverlapArea(
  bbox1: BBox,
  bbox2: BBox
): number {
  const xOverlap = Math.max(
    0,
    Math.min(bbox1.x + bbox1.width, bbox2.x + bbox2.width) -
      Math.max(bbox1.x, bbox2.x)
  )
  const yOverlap = Math.max(
    0,
    Math.min(bbox1.y + bbox1.height, bbox2.y + bbox2.height) -
      Math.max(bbox1.y, bbox2.y)
  )
  return xOverlap * yOverlap
}
```

---

## 10. 测试要点

### 10.1 功能测试
- [ ] 从物料面板拖拽节点到画布成功
- [ ] 设备节点移入容器时容器高亮
- [ ] 停留 200ms 后高亮加强（边框加粗）
- [ ] 松手后设备成功入组容器
- [ ] 入组后设备位置保持不变（视觉上）
- [ ] 设备外溢超过 50% 时自动出组
- [ ] 出组后设备位置保持不变（视觉上）

### 10.2 交互测试
- [ ] 拖拽流畅无卡顿
- [ ] 高亮反馈及时（< 50ms）
- [ ] 入组/出组动画流畅
- [ ] 拖拽中节点始终在最顶层
- [ ] 入组后子节点在父节点上方

### 10.3 边界测试
- [ ] 快速拖拽不触发误入组
- [ ] 拖拽到画布边缘正常处理
- [ ] 容器移动时子节点跟随
- [ ] 删除容器时子节点正确处理
- [ ] 多层嵌套（未来功能）坐标转换正确

### 10.4 数据测试
- [ ] 入组后 childrenIds 正确更新
- [ ] 出组后 childrenIds 正确移除
- [ ] 父子关系在 Store 中正确反映
- [ ] 导出 JSON 后父子关系正确

---

## 11. 验收标准

### 11.1 功能验收
- ✅ 物料面板正常显示所有物料项
- ✅ 能够拖拽物料项到画布
- ✅ 设备节点能够入组容器
- ✅ 设备节点能够出组容器
- ✅ 入组/出组过程位置无跳变
- ✅ zIndex 层级关系正确
- ✅ 视觉反馈及时准确

### 11.2 性能验收
- ✅ 拖拽操作响应时间 < 16ms（60 FPS）
- ✅ 入组检测延迟 < 50ms
- ✅ 坐标转换计算时间 < 10ms
- ✅ 100 个节点场景下拖拽流畅

### 11.3 代码质量验收
- ✅ 通过 ESLint 检查
- ✅ 通过 TypeScript 编译
- ✅ 坐标转换函数有单元测试
- ✅ 关键逻辑有清晰注释

---

## 12. 注意事项

### 12.1 性能优化

#### 12.1.1 检测优化
- 使用节流（throttle）处理 mousemove 事件
- 仅检测可见区域的容器节点
- 使用空间索引加速碰撞检测（可选）

#### 12.1.2 渲染优化
- 高亮状态使用 CSS 动画而非 JS 动画
- 避免频繁修改 attrs
- 使用 requestAnimationFrame 优化动画

### 12.2 交互体验

#### 12.2.1 防误触
- 入组停留时间不少于 200ms
- 出组持续时间不少于 100ms
- 快速拖拽不触发入组

#### 12.2.2 视觉一致性
- 坐标转换确保位置无跳变
- 入组/出组动画平滑
- 高亮反馈明显但不刺眼

### 12.3 常见问题

#### Q1: 入组后节点位置跳变？
**A**: 检查坐标转换是否正确，确保转换前后的绝对位置一致。

#### Q2: 容器不高亮？
**A**: 检查定时器是否被正确清除，检查事件监听是否正常。

#### Q3: 出组检测不灵敏？
**A**: 调整重叠面积阈值（50%），或减少检测延迟。

#### Q4: zIndex 混乱？
**A**: 建立统一的 zIndex 管理器，避免手动设置 zIndex。

### 12.4 开发建议

#### 12.4.1 调试技巧
- 在控制台打印坐标信息
- 使用 Chrome DevTools 查看事件触发
- 临时显示包围盒边界（调试模式）

#### 12.4.2 代码组织
- 将入组/出组逻辑拆分为独立 Composable
- 坐标转换工具函数独立封装
- 常量配置集中管理（延迟时间、阈值等）

---

## 13. 后续步骤预告

完成本步骤后，将进入 **Step 4 - 容器自动扩容**，届时将：
- 监听子节点的位置和尺寸变化
- 动态计算容器的包围盒
- 自动调整容器尺寸和位置
- 实现容器的最小尺寸约束

**关键衔接点**：
- 本步骤建立的父子关系是扩容的前提
- 本步骤的坐标系统将在扩容时复用

---

**文档版本**：1.2.0  
**创建时间**：2026-02-09  
**最后更新**：2026-02-09  
**预估工时**：2.3 天（18.5 小时）  
**优先级**：P0（必须完成）  
**变更记录**：
- v1.2.0: 修正导入语句，直接使用 `import { Dnd, Stencil } from '@antv/x6'`
- v1.1.0: 修正插件依赖方式，X6 3.x 插件已内置，无需额外安装
- v1.1.0: 增加物料面板实现方案选择说明
- v1.1.0: 调整 T3-2 工时从 2h 到 2.5h
